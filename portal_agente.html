<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal del Agente</title>
<style>
  body{font-family:Arial;background:#f4f6fb;margin:0;padding:18px}
  .card{max-width:980px;margin:auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(10,20,30,0.06)}
  h2{margin-top:0}
  label{display:block;margin-top:10px;font-weight:600}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px;box-sizing:border-box}
  .row{display:flex;gap:10px}
  canvas{border:1px solid #e6eef9;border-radius:6px}
  .btn{background:#0f4c81;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;margin-top:10px}
  .btn.ghost{background:#fff;color:#0f4c81;border:1px solid #cbd5e1}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
  th{background:#fbfdff}
</style>
</head>
<body>

<div class="card">
  <h2>Portal del Agente</h2>

  <label>Seleccionar Asesor</label>
  <select id="selAgent" onchange="loadAgentList()">
    <option value="">-- selecciona --</option>
  </select>

  <div style="margin-top:12px">
    <strong>Feedbacks del agente</strong>
    <table id="agentTable">
      <thead><tr><th>ID</th><th>Fecha</th><th>Nota</th><th>Estado</th><th>Acci√≥n</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="detailBlock" style="display:none;margin-top:12px">
    <h3>Completar Feedback</h3>
    <div id="feedbackInfo"></div>

    <label>Compromiso del agente</label>
    <textarea id="compromiso" rows="4"></textarea>

    <label>Firma (dibujar)</label>
    <canvas id="canvas" width="700" height="140"></canvas>

    <div style="display:flex;gap:8px">
      <button class="btn" onclick="saveSignature()">Enviar Firma y Completar</button>
      <button class="btn ghost" onclick="clearCanvas()">Limpiar Firma</button>
    </div>

    <div id="agentMsg" style="margin-top:10px;color:green"></div>
  </div>

</div>

<script>
// ============= API BASE URL =============
const API = "/.netlify/functions";

// ============= LOAD ADVISORS =============
async function loadAdvisors() {
  try {
    const res = await fetch(`${API}/records`);
    const data = await res.json();
    if (!data.ok) return alert("No se pudo cargar asesores");

    const advisors = [...new Set(data.records.map(r => r.asesor).filter(Boolean))];

    const sel = document.getElementById('selAgent');
    sel.innerHTML = '<option value="">-- selecciona --</optio
