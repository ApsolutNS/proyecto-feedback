<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Refuerzos & Capacitaciones ‚Äì Calidad FE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Estilos -->
  <link rel="stylesheet" href="css/refuerzos.css" />

  <!-- Quill Editor (WYSIWYG b√°sico) -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js" defer></script>

  <!-- html2pdf (para exportar PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js" defer></script>
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="header-left">
      <div class="header-title">
        <span class="logo">FE</span>
        Refuerzos & Capacitaciones
      </div>

      <div class="header-sub">
        Registro oficial de acciones de Calidad & Formaci√≥n ‚Äì Financiera Efectiva.
      </div>

      <div class="header-meta">
        <div class="pill">
          <span class="pill-dot"></span>
          M√≥dulo interno de Calidad
        </div>
        <div class="pill">
          Responsable: Alex Paolo Nu√±ez Sulca ‚Äì L√≠der de Calidad y Formaci√≥n
        </div>
      </div>
    </div>

    <div class="header-right">
      <button id="btnIrBuscador" class="btn-sm">üîé Ir al Dashboard</button>
      <button id="themeToggle" class="btn-toggle">üåô Modo oscuro</button>
    </div>
  </header>

  <!-- CONTENEDOR PRINCIPAL -->
  <div class="container">
    <div class="layout-grid">

      <!-- FORMULARIO -->
      <section class="card" id="cardFormulario">
        <div class="card-header">
          <div>
            <div class="card-title">Nuevo refuerzo / capacitaci√≥n</div>
            <div class="card-sub">
              Registra solo acciones formales de refuerzo, feedback o capacitaci√≥n asociadas a Calidad.
            </div>
          </div>
          <span class="chip">Solo Calidad & Formaci√≥n</span>
        </div>

        <div class="form-grid">
          <div>
            <label for="fecha">Fecha del refuerzo</label>
            <input type="date" id="fecha" />
          </div>

          <div>
            <label for="tipo">Tipo de acci√≥n</label>
            <select id="tipo">
              <option value="">Seleccione</option>
              <option>Capacitaci√≥n grupal</option>
              <option>Refuerzo 1:1</option>
              <option>Feedback de calidad</option>
              <option>Recordatorio normativo</option>
              <option>Coaching / role play</option>
            </select>
          </div>

          <div>
            <label for="tema">Tema / t√≠tulo</label>
            <input id="tema" placeholder="Ej. Manejo de objeciones SBS / Script de bienvenida" />
          </div>

          <div>
            <label for="canal">Canal</label>
            <select id="canal">
              <option value="">Seleccione</option>
              <option>Presencial</option>
              <option>Teams</option>
              <option>Llamada</option>
              <option>Otro</option>
            </select>
          </div>

          <!-- ASESORES -->
          <div class="chips-wrapper">
            <div class="chips-label-row">
              <span class="hint"><b>Asesores capacitados</b> (selecci√≥n m√∫ltiple)</span>
              <span class="hint">Datos en tiempo real desde colecci√≥n <b>usuarios</b></span>
            </div>
            <div id="asesoresContainer" class="chips-container"></div>
          </div>

          <div>
            <label for="responsable">Responsable</label>
            <input
              id="responsable"
              value="Alex Paolo Nu√±ez Sulca - L√≠der de Calidad y Formaci√≥n"
              readonly
            />
          </div>
        </div>

        <div style="margin-top: 10px">
          <label for="objetivo">Objetivo del refuerzo</label>
          <textarea
            id="objetivo"
            rows="2"
            placeholder="Ej. Reforzar cumplimiento SBS en fase de ofrecimiento, reducir errores de cierre, etc."
          ></textarea>
        </div>

        <!-- ‚úÖ EDITOR RICO (Quill) para Detalle / acuerdos clave -->
        <div style="margin-top: 10px">
          <label>Detalle / acuerdos clave</label>
          <div class="editor-toolbar">
            <button type="button" data-cmd="bold"><b>B</b></button>
            <button type="button" data-cmd="italic"><i>I</i></button>
            <button type="button" data-cmd="underline"><u>U</u></button>
            <button type="button" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
          </div>
          <div
            id="detalleEditor"
            class="editor-box"
            contenteditable="true"
            placeholder="Escribe el detalle del refuerzo, acuerdos, compromisos..."
          ></div>
          <input type="hidden" id="detalle" />

          <!-- (Opcional) ayuda visual -->
          <div class="hint" style="margin-top:6px">
            Tip: Puedes usar <b>negrita</b>, <i>cursiva</i>, listas y enlaces.
          </div>
        </div>

        <div class="form-footer">
          <div class="hint">
            <div>‚úî Luego el agente podr√° firmar este refuerzo desde <b>portal_agente.html</b>.</div>
            <div>‚úî El PDF se genera desde aqu√≠ con las firmas de Alex + agentes.</div>
          </div>

          <div style="display: flex; gap: 8px; flex-wrap: wrap">
            <button class="btn-secondary" type="button" id="btnLimpiar">Limpiar</button>
            <button class="btn" type="button" id="btnGuardar">üíæ Guardar refuerzo</button>
          </div>
        </div>
      </section>

      <!-- LISTADO -->
      <section class="card" id="cardListado">
        <div class="card-header">
          <div>
            <div class="card-title">Historial de refuerzos</div>
            <div class="card-sub">
              Vista ejecutiva del avance de firmas y estado de cada acci√≥n de calidad.
            </div>
          </div>
        </div>

        <!-- M√âTRICAS -->
        <div class="metrics-row">
          <div class="metric-pill">
            Total refuerzos: <span class="metric-value" id="metricTotal">0</span>
          </div>
          <div class="metric-pill">
            Firmados: <span class="metric-value" id="metricFirmados">0</span>
          </div>
          <div class="metric-pill">
            Pendientes de firma: <span class="metric-value" id="metricPendientes">0</span>
          </div>
        </div>

        <!-- FILTROS -->
        <div class="filters-row">
          <input
            id="searchTabla"
            class="search-input"
            placeholder="Buscar por agente, tema, tipo, p√∫blico‚Ä¶"
          />
          <select id="filtroEstado" class="compact">
            <option value="todos">Estado: todos</option>
            <option value="pendiente">Pendiente de firma</option>
            <option value="firmado">Firmado</option>
            <option value="incompleto">Datos incompletos</option>
          </select>
        </div>

        <!-- TABLA -->
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tema / Tipo</th>
                <th>P√∫blico</th>
                <th>Firma</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaRefuerzos"></tbody>
          </table>
        </div>

        <div
          style="
            margin-top: 8px;
            font-size: 11px;
            color: var(--muted);
            display: flex;
            justify-content: space-between;
            gap: 6px;
            flex-wrap: wrap;
          "
        >
          <span class="badge-inline">
            <span class="badge-dot-success"></span> Firmado por agente
          </span>
          <span class="badge-inline">
            <span class="badge-dot-warning"></span> Pendiente de firma / datos
          </span>
        </div>
      </section>
    </div>
  </div>

  <!-- OVERLAY CARGA -->
  <div id="loadingOverlay">
    <div id="loadingText">Procesando‚Ä¶</div>
    <div class="loader-bar">
      <div class="loader-bar-inner"></div>
    </div>
  </div>

  <!-- MODAL PDF -->
  <div id="pdfModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <span id="pdfModalTitle">Vista previa del refuerzo</span>
        <button class="modal-close" id="pdfCloseBtn">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="pdfContentRefuerzo" class="pdf-content"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" type="button" id="pdfDownloadBtn">‚¨á Descargar PDF</button>
        <button class="btn-secondary" type="button" id="pdfCloseBtnFooter">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ INIT QUILL + SYNC con textarea#detalle (para mantener tu JS funcionando) -->
  <script>
    // Espera a que Quill cargue (porque viene con defer)
    window.addEventListener("DOMContentLoaded", () => {
      const editorEl = document.getElementById("detalleEditor");
      const hiddenTextarea = document.getElementById("detalle");
      if (!editorEl || !hiddenTextarea) return;

      // Si tu JS ya guardaba texto plano en #detalle, lo cargamos como HTML simple
      const initial = (hiddenTextarea.value || "").trim();

      // Toolbar b√°sica: negrita, cursiva, subrayado, listas, link, limpiar formato
      const toolbarOptions = [
        ["bold", "italic", "underline"],
        [{ "list": "ordered" }, { "list": "bullet" }],
        ["link"],
        ["clean"]
      ];

      const quill = new Quill(editorEl, {
        theme: "snow",
        modules: { toolbar: toolbarOptions },
        placeholder: "Escribe aqu√≠ el detalle / acuerdos clave‚Ä¶"
      });

      // Si hab√≠a contenido previo, intentar cargarlo:
      if (initial) {
        // Si te llega texto plano, esto lo pone como un p√°rrafo.
        quill.clipboard.dangerouslyPasteHTML(initial);
      }

      // Sincroniza a textarea oculto para que tu refuerzos.js lo lea igual que antes
      const syncToTextarea = () => {
        const html = editorEl.querySelector(".ql-editor")?.innerHTML ?? "";
        hiddenTextarea.value = html;
      };

      quill.on("text-change", syncToTextarea);
      syncToTextarea();

      // Exponer por si tu JS lo quiere usar despu√©s (opcional)
      window.detalleQuill = quill;
    });
  </script>

  <!-- L√ìGICA -->
  <script type="module" src="js/refuerzos.js"></script>
</body>
</html>
