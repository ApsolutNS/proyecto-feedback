<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visualización Feedback</title>
<style>
  body{font-family:Arial;background:#f4f6fb;margin:0;padding:18px}
  .card{max-width:980px;margin:auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(10,20,30,0.06)}
  h2{margin-top:0}
  input{width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:6px}
  .doc{border:1px solid #e6eef9;padding:12px;border-radius:6px;margin-top:12px;background:#fff}
  .nota{background:#ffecec;border:1px solid #ffbdbd;color:#b30000;padding:10px;border-radius:6px;font-weight:700;text-align:center}
  .firma{border:1px solid #ddd;padding:6px;border-radius:6px;display:inline-block;margin-top:8px}
  .btn{background:#0f4c81;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;margin-top:12px}
</style>
</head>
<body>

<div class="card">
  <h2>Visualización del Feedback (Final)</h2>

  <label>Buscar por ID</label>
  <input id="searchId" placeholder="Pegue el ID del feedback (ej. FB-...)">
  <div style="display:flex;gap:8px">
    <button class="btn" onclick="showFeedback()">Mostrar</button>
    <button class="btn" onclick="downloadHtml()">Descargar HTML (simula PDF)</button>
  </div>

  <div id="preview" class="doc" style="margin-top:14px">Aquí se mostrará el feedback final cuando busques por ID.</div>
</div>

<script>
function getDB(){ return JSON.parse(localStorage.getItem('fb_registros_v1')||'[]'); }

function showFeedback(){
  const id = document.getElementById('searchId').value.trim();
  if(!id) return alert('Ingresa un ID');
  const db = getDB();
  const rec = db.find(r=>r.id===id);
  if(!rec) return alert('No encontrado');
  // build HTML preview (improved template)
  const html = buildTemplate(rec);
  document.getElementById('preview').innerHTML = html;
}

function buildTemplate(rec){
  const imgsHtml = rec.images.map(im=>`<img src="${im.data}" style="max-width:120px;margin-right:8px;border-radius:6px">`).join('');
  const itemsHtml = rec.items.map(it=>`<div style="margin-bottom:6px"><strong>${it.name}</strong> (${it.perc}%)<div style="color:#333">${it.detail||''}</div></div>`).join('');
  const firmaHtml = rec.firmaDataUrl? `<div class="firma"><img src="${rec.firmaDataUrl}" style="max-width:260px"></div>` : `<div class="firma" style="height:80px;display:flex;align-items:center;justify-content:center;color:#64748b">SIN FIRMA</div>`;
  return `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px">
      <div style="flex:1">
        <h3 style="margin:0">${rec.tipo==='EFECTIVA'?'RETROALIMENTACIÓN':'RETROALIMENTACIÓN'}</h3>
        <div style="color:#64748b">Fecha: ${new Date(rec.fechaHora).toLocaleString()}</div>
        <div style="margin-top:10px"><strong>Asesor:</strong> ${rec.asesor} / <strong>Cargo:</strong> ${rec.cargo}</div>
        <div style="margin-top:10px;"><strong>Cliente:</strong> ${rec.cliente.nombre} (DNI: ${rec.cliente.dni})</div>
        <div style="margin-top:10px"><strong>Resumen:</strong><div style="padding:8px;background:#fbfdff;border-radius:6px">${rec.resumen}</div></div>
        <div style="margin-top:10px"><strong>Items observados:</strong>${itemsHtml}</div>
        <div style="margin-top:10px"><strong>Reincidencia:</strong> ${rec.reincidencia}</div>
        <div style="margin-top:10px"><strong>Evidencias:</strong><div style="margin-top:6px">${imgsHtml}</div></div>
        <div style="margin-top:10px"><strong>Compromiso del agente:</strong><div style="padding:8px;border:1px dashed #e6eef9;border-radius:6px">${rec.compromiso||'<em>Vacío</em>'}</div></div>
      </div>
      <div style="width:260px">
        <div class="nota" style="font-size:28px">${rec.nota}%</div>
        <div style="margin-top:12px">${firmaHtml}</div>
        <div style="margin-top:12px;color:#64748b">ID: ${rec.id}</div>
      </div>
    </div>
  `;
}

function downloadHtml(){
  const div = document.getElementById('preview');
  const content = div.innerHTML;
  if(!content) return alert('Genera la vista antes de descargar');
  const blob = new Blob([`<html><head><meta charset="utf-8"></head><body>${content}</body></html>`], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (document.getElementById('searchId').value || 'feedback') + '.html';
  a.click();
}
</script>

</body>
</html>
