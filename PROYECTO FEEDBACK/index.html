<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard - Supervisión</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f6fb;margin:0;color:#0b1220}
  header{background:#0f4c81;color:#fff;padding:16px 24px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  .container{padding:18px;display:grid;grid-template-columns:260px 1fr;gap:16px}
  .left{display:flex;flex-direction:column;gap:12px}
  .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(15,20,30,0.06)}
  .btn{padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;width:100%}
  .btn.primary{background:#0f4c81;color:#fff}
  .btn.secondary{background:#fff;border:1px solid #cbd5e1}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:6px;border-bottom:1px solid #eef2f7;text-align:left}
  th{background:#fbfdff;color:#334155}
  .weekly{overflow:auto}
  .small{font-size:13px;color:#64748b}
</style>
</head>
<body>

<header>
  <h1>Panel Principal - Calidad & Monitoreo</h1>
  <div style="font-size:13px">Usuario: <strong>Supervisor</strong></div>
</header>

<div class="container">

  <!-- ASIDE -->
  <aside class="left">

    <div class="card">
      <h3>Accesos rápidos</h3>
      <button class="btn primary" onclick="location.href='registro.html'">1 · Registro</button>
      <button class="btn secondary" onclick="location.href='portal_agente.html'">2 · Portal del Agente</button>
      <button class="btn secondary" onclick="location.href='visualizacion_feedback.html'">3 · Visualización Feedback</button>
    </div>

    <div class="card">
      <h3>Tipo monitoreo (conteo)</h3>
      <p class="small"><b>EFECTIVA:</b> <span id="cntEfectiva">0</span></p>
      <p class="small"><b>EFECTIVANK:</b> <span id="cntEfectivank">0</span></p>
      <p class="small"><b>XPERTO:</b> <span id="cntXperto">0</span></p>
      <p class="small"><b>FACEBOOK:</b> <span id="cntFb">0</span></p>
      <p class="small"><b>INSTAGRAM:</b> <span id="cntIg">0</span></p>
      <p class="small"><b>CORREO:</b> <span id="cntMail">0</span></p>
    </div>

  </aside>

  <!-- MAIN -->
  <main>

    <!-- GRÁFICO -->
    <div class="card" style="margin-bottom:12px">
      <canvas id="chartMonth" height="100"></canvas>
    </div>

    <!-- TABLA SEMANAL -->
    <div class="card">
      <h3>Tabla semanal del mes</h3>
      <div class="small">Cada semana muestra dos columnas: conteos por tipo (resumen corto)</div>
      <div class="weekly" style="margin-top:10px">
        <table id="weeklyTable">
          <thead id="weeklyHead"></thead>
          <tbody id="weeklyBody"></tbody>
        </table>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <h3>Últimos registros</h3>
      <table id="recentTable">
        <thead><tr><th>Fecha Hora</th><th>Asesor</th><th>Nota</th><th>Tipo</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </main>
</div>

<script>
// -------------- API URL ----------------
const API = "/.netlify/functions/records";

// -------------- FETCH ALL RECORDS ------
async function getAllRecords() {
  const res = await fetch(API);
  const data = await res.json();
  return data.ok ? data.records : [];
}

// detect type
function detectarTipo(text){
  if(!text) return 'OTRO';
  text = text.toLowerCase();
  if(text.includes('intefectivank') || text.includes('vank')) return 'EFECTIVANK';
  if(text.includes('intefectiva')) return 'EFECTIVA';
  if(text.includes('intxperto')) return 'XPERTO';
  if(text.includes('facebook')) return 'FACEBOOK';
  if(text.includes('instagram')) return 'INSTAGRAM';
  if(text.includes('correo') || text.includes('mail')) return 'CORREO';
  return 'OTRO';
}

// weeks of month
function getWeeksOfMonth(date = new Date()){
  const year = date.getFullYear(), month = date.getMonth();
  const last = new Date(year, month+1, 0).getDate();
  const weeks = [];
  let day = 1;
  while(day <= last){
    const start = day;
    const end = Math.min(day + 6, last);
    weeks.push({startDay:start, endDay:end});
    day = end + 1;
  }
  return weeks;
}

// CHART INIT
const ctx = document.getElementById('chartMonth').getContext('2d');
const chart = new Chart(ctx, {
  type: 'bar',
  data: { labels: [], datasets:[{label:'Promedio %', data:[], backgroundColor:'#0f4c81'}]},
  options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,max:100}}}
});

// ----------------- REFRESH DASHBOARD -----------------
async function refreshDashboard(){
  const db = await getAllRecords();

  // fill type counts
  const counts = {EFECTIVA:0,EFECTIVANK:0,XPERTO:0,FACEBOOK:0,INSTAGRAM:0,CORREO:0,OTRO:0};
  db.forEach(r=> counts[r.tipo] = (counts[r.tipo]||0)+1 );
  
  document.getElementById('cntEfectiva').innerText = counts.EFECTIVA;
  document.getElementById('cntEfectivank').innerText = counts.EFECTIVANK;
  document.getElementById('cntXperto').innerText = counts.XPERTO;
  document.getElementById('cntFb').innerText = counts.FACEBOOK;
  document.getElementById('cntIg').innerText = counts.INSTAGRAM;
  document.getElementById('cntMail').innerText = counts.CORREO;

  // recent table
  const recent = db.slice().reverse().slice(0,8);
  document.querySelector('#recentTable tbody').innerHTML =
    recent.map(r=>`
      <tr>
        <td>${new Date(r.fechaHora).toLocaleString()}</td>
        <td>${r.asesor}</td>
        <td>${r.nota}%</td>
        <td>${r.tipo}</td>
      </tr>
    `).join("") || '<tr><td colspan="4">Sin registros</td></tr>';

  // weekly table
  const weeks = getWeeksOfMonth();
  document.getElementById('weeklyHead').innerHTML =
    `<tr><th>ASESOR</th>` +
    weeks.map((_,i)=>`<th>SEM ${i+1} C1</th><th>SEM ${i+1} C2</th>`).join("") +
    `</tr>`;

  const advisors = [...new Set(db.map(r=>r.asesor).filter(Boolean))];
  const tbody = advisors.map(a=>{
    let row = `<tr><td>${a}</td>`;
    for (let w=0; w<weeks.length; w++){
      const recs = db.filter(r=>{
        const d = new Date(r.fechaHora);
        const day = d.getDate();
        return r.asesor===a && day>=weeks[w].startDay && day<=weeks[w].endDay;
      });
      const c1 = recs[0]?.tipo || "-";
      const c2 = recs[1]?.tipo || "-";
      row += `<td>${c1}</td><td>${c2}</td>`;
    }
    return row + "</tr>";
  }).join("");

  document.getElementById('weeklyBody').innerHTML = tbody || 
    `<tr><td colspan="${1 + weeks.length*2}">Sin registros</td></tr>`;

  // chart averages
  const values = weeks.map(w=>{
    const recs = db.filter(r=>{
      const d = new Date(r.fechaHora);
      const day = d.getDate();
      return day>=w.startDay && day<=w.endDay;
    });
    if (!recs.length) return 0;
    const avg = recs.reduce((s,r)=>s+(parseFloat(r.nota)||0), 0) / recs.length;
    return Math.round(avg);
  });

  chart.data.labels = weeks.map((_,i)=>'S'+(i+1));
  chart.data.datasets[0].data = values;
  chart.update();
}

// RUN
refreshDashboard();
</script>
</body>
</html>
