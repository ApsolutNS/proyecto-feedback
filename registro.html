<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Monitoreo</title>

<style>
  body{font-family:Arial;background:#f4f6fb;margin:0;padding:18px}
  .card{max-width:980px;margin:auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(10,20,30,0.06)}
  h2{margin-top:0}
  label{display:block;margin-top:10px;font-weight:600}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px;box-sizing:border-box}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .items-list{margin-top:10px}
  .item-block{border:1px solid #e6eef9;padding:8px;border-radius:6px;margin-top:8px;display:flex;gap:8px;align-items:flex-start}
  .btn{background:#0f4c81;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;margin-top:12px}
  .btn.ghost{background:#fff;color:#0f4c81;border:1px solid #cbd5e1}
  .small{font-size:13px;color:#64748b}
  .img-preview{max-height:90px;margin-right:8px;border-radius:6px}
</style>
</head>
<body>

<div class="card">
  <h2>Registro del Monitoreo (Supervisor)</h2>

  <label>ID LLAMADA</label>
  <input id="idLlamada">

  <label>ID CONTACTO</label>
  <input id="idContacto">

  <label>Tipo detectado</label>
  <input id="tipoDetectado" readonly>

  <div style="display:flex;gap:8px;margin-top:10px">
    <div style="flex:1">
      <label>Asesor</label>
      <select id="asesor"></select>
      <small class="small">* Cargado desde Firestore</small>
    </div>
    <div style="width:220px">
      <label>Cargo</label>
      <select id="cargo">
        <option>ASESOR INBOUND</option>
        <option>ASESOR CORREOS</option>
        <option>ASESOR REDES</option>
      </select>
    </div>
  </div>

  <h3 class="small" style="margin-top:12px">Datos del cliente</h3>

  <div class="row">
    <div class="col">
      <label>DNI cliente</label>
      <input id="cliDni">
    </div>
    <div class="col">
      <label>Nombre cliente</label>
      <input id="cliNombre">
    </div>
    <div class="col">
      <label>Teléfono</label>
      <input id="cliTel">
    </div>
  </div>

  <label>Tipificación</label>
  <input id="cliTipif">

  <label>Observación cliente</label>
  <textarea id="cliObs"></textarea>

  <label>Resumen de la llamada</label>
  <textarea id="resumen" rows="4"></textarea>

  <h3 style="margin-top:12px">Items observados</h3>
  <div class="small">Agrega uno o varios items</div>

  <div style="display:flex;gap:8px;margin-top:8px">
    <button class="btn" onclick="addItemBlock()">+ Agregar ítem</button>
    <button class="btn ghost" onclick="clearItems()" style="width:130px">Limpiar items</button>
  </div>

  <div id="itemsContainer" class="items-list"></div>

  <label style="margin-top:12px">Adjuntar imágenes</label>
  <input id="imgs" type="file" multiple accept="image/*" />
  <div id="imgPreview" style="display:flex;margin-top:8px;flex-wrap:wrap"></div>

  <button class="btn" onclick="submitRecord()">Registrar</button>
  <div id="msg" style="margin-top:12px;color:green"></div>
</div>

<script type="module">
/* --------------------- IMPORTS FIREBASE ------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

/* --------------------- CONFIG FIREBASE ------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD4cFHDbSfJNAhTuuP01N5JZQd-FOYB2LM",
  authDomain: "feedback-app-ac30e.firebaseapp.com",
  projectId: "feedback-app-ac30e",
  storageBucket: "feedback-app-ac30e.firebasestorage.app",
  messagingSenderId: "512179147778",
  appId: "1:512179147778:web:795e4a8b177fe766d3431b",
  measurementId: "G-X6MP0FFH9P"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* --------------------- CARGAR ASESORES ------------------------- */
async function cargarAsesores() {
  const q = await getDocs(collection(db, "asesores"));
  const asesores = [];
  q.forEach(doc => asesores.push(doc.data().nombre));

  document.getElementById("asesor").innerHTML =
    asesores.map(a => `<option>${a}</option>`).join("");
}
cargarAsesores();

/* --------------------- DETECTAR TIPO -------------------------- */
function detectarTipoTexto(text){
  if(!text) return 'NO IDENTIFICADO';
  text = text.toLowerCase();

  if(text.includes('intefectivank') || text.includes('vank')) return 'EFECTIVANK';
  if(text.includes('intefectiva')) return 'EFECTIVA';
  if(text.includes('intxperto')) return 'XPERTO';
  if(text.includes('facebook')) return 'FACEBOOK';
  if(text.includes('instagram')) return 'INSTAGRAM';
  if(text.includes('correo') || text.includes('mail')) return 'CORREO';

  return 'OTRO';
}

document.getElementById('idLlamada').addEventListener('input', updateDetected);
document.getElementById('idContacto').addEventListener('input', updateDetected);

function updateDetected(){
  const v = idLlamada.value + " " + idContacto.value;
  tipoDetectado.value = detectarTipoTexto(v);
}

/* --------------------- ITEMS DISPONIBLES (ACTUALIZADO) --------
   name  = descripción del ítem
   perc  = peso dentro del grupo (se usa en PENCUF)
   group = ERROR | PENCUF | PECNEG | PECUF | PECCUMP | NONE
-----------------------------------------------------------------*/
const ITEMS = [
  // ERROR INEXCUSABLE (nota = 0)
  { name: "Corte de Gestión", perc: 0, group: "ERROR" },
  { name: "Insulto / Falta de Respeto", perc: 0, group: "ERROR" },
  { name: "Normativa Regulatoria", perc: 0, group: "ERROR" },
  { name: "Protección de datos", perc: 0, group: "ERROR" },

  // PENCUF (grupo 25%, proporcional)
  { name: "Contestación sin demora", perc: 5, group: "PENCUF" },
  { name: "Optimización de esperas", perc: 5, group: "PENCUF" },
  { name: "Empatía e implicación", perc: 7, group: "PENCUF" },
  { name: "Escucha Activa", perc: 7, group: "PENCUF" },
  { name: "Sondeo", perc: 7, group: "PENCUF" },
  { name: "Solicita datos de forma correcta y oportuna", perc: 7, group: "PENCUF" },
  { name: "Herramientas de Gestión", perc: 10, group: "PENCUF" },
  { name: "Codificación y Registro inConcert", perc: 7, group: "PENCUF" },
  { name: "Codificación y Registro en Monitor Logístico", perc: 7, group: "PENCUF" },
  { name: "Codificación y Registro en SmartSheet", perc: 7, group: "PENCUF" },
  { name: "Presentación", perc: 7, group: "PENCUF" },
  { name: "Personalización", perc: 7, group: "PENCUF" },
  { name: "Despedida", perc: 7, group: "PENCUF" },
  { name: "Encuesta de satisfacción", perc: 10, group: "PENCUF" },

  // PECNEG (grupo 30%, si hay ≥1 se descuenta 30)
  { name: "Lenguaje", perc: 30, group: "PECNEG" },
  { name: "Voz", perc: 30, group: "PECNEG" },
  { name: "Redacta de forma Correcta", perc: 30, group: "PECNEG" },
  { name: "Imagen trasladada", perc: 30, group: "PECNEG" },
  { name: "Actitud comercial", perc: 30, group: "PECNEG" },
  { name: "Operativa", perc: 30, group: "PECNEG" },
  { name: "Tramita la gestión correspondiente", perc: 30, group: "PECNEG" },
  { name: "Transferencia", perc: 30, group: "PECNEG" },

  // PECUF (grupo 35%, si hay ≥1 se descuenta 35)
  { name: "Cumple con devolución de llamado", perc: 35, group: "PECUF" },
  { name: "Actitud - Manejo de llamada", perc: 35, group: "PECUF" },
  { name: "Conocimientos para resolver la consulta", perc: 35, group: "PECUF" },
  { name: "Asesoramiento de Producto o Servicio (Pagina Web | Posible Compra | Servicios)", perc: 35, group: "PECUF" },
  { name: "Solución al primer contacto", perc: 35, group: "PECUF" },

  // PECCUMP (grupo 10%, si hay ≥1 se descuenta 10)
  { name: "Verificación de datos", perc: 10, group: "PECCUMP" },
  { name: "Damos el número de Ticket", perc: 10, group: "PECCUMP" },

  // Ninguno (no penaliza)
  { name: "Ninguno", perc: 0, group: "NONE" }
];

/* --------------------- AGREGAR ITEM ---------------------- */
window.addItemBlock = function() {
  const w = document.createElement('div');
  w.className = 'item-block';
  w.innerHTML = `
    <select>
      ${ITEMS.map(it => 
        `<option value="${it.name}||${it.perc}||${it.group}">
           ${it.name} (${it.perc}%)
         </option>`
      ).join("")}
    </select>
    <textarea placeholder="Detalle del item"></textarea>
    <button class="btn ghost" style="width:90px" onclick="this.parentNode.remove()">Eliminar</button>
  `;
  document.getElementById("itemsContainer").appendChild(w);
};

window.clearItems = function(){
  document.getElementById("itemsContainer").innerHTML = "";
};

/* --------------------- PREVIEW IMÁGENES ---------------------- */
document.getElementById('imgs').addEventListener('change', function(){
  const preview = document.getElementById('imgPreview');
  preview.innerHTML = "";

  [...this.files].forEach(f=>{
    const fr = new FileReader();
    fr.onload = e=>{
      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "img-preview";
      img.style.maxWidth = "120px";
      preview.appendChild(img);
    };
    fr.readAsDataURL(f);
  });
});

/* --------------------- CÁLCULO DE NOTA ---------------------- */
/*
  Reglas:
  - Si hay un ítem group === "ERROR" → nota = 0, tipo = "ERROR INEXCUSABLE"
  - PENCUF (25%): descuento = (suma perc / 100) * 25
  - PECNEG (30%): si hay ≥1 → descuento = 30
  - PECUF (35%): si hay ≥1 → descuento = 35
  - PECCUMP (10%): si hay ≥1 → descuento = 10
  - Sólo NONE → nota = 100, tipo = "NINGUNO"
*/
function calcularNotaConDetalle(items) {
  const detalle = {
    ERROR: [],
    PENCUF: [],
    PECNEG: [],
    PECUF: [],
    PECCUMP: [],
    NONE: []
  };

  for (const it of items) {
    if (!detalle[it.group]) detalle[it.group] = [];
    detalle[it.group].push(it);
  }

  const descuentos = {
    PENCUF: 0,
    PECNEG: 0,
    PECUF: 0,
    PECCUMP: 0
  };

  // Caso ERROR INEXCUSABLE
  if (detalle.ERROR.length > 0) {
    return {
      nota: 0,
      tipo: "ERROR INEXCUSABLE",
      detalle,
      descuentos
    };
  }

  // Sólo "Ninguno" (o sin ítems) → 100%
  const totalItems = items.length;
  const nonNone = items.filter(i => i.group !== "NONE").length;
  if (totalItems > 0 && nonNone === 0) {
    return {
      nota: 100,
      tipo: "NINGUNO",
      detalle,
      descuentos
    };
  }

  let nota = 100;
  let tipo = "NINGUNO";

  // PENCUF (25%) → proporcional
  if (detalle.PENCUF && detalle.PENCUF.length > 0) {
    const sumaPerc = detalle.PENCUF.reduce((acc, it) => acc + (it.perc || 0), 0);
    descuentos.PENCUF = (sumaPerc / 100) * 25;
    nota -= descuentos.PENCUF;
    tipo = "PENCUF";
  }

  // PECNEG (30%)
  if (detalle.PECNEG && detalle.PECNEG.length > 0) {
    descuentos.PECNEG = 30;
    nota -= descuentos.PECNEG;
    tipo = "PECNEG";
  }

  // PECUF (35%)
  if (detalle.PECUF && detalle.PECUF.length > 0) {
    descuentos.PECUF = 35;
    nota -= descuentos.PECUF;
    tipo = "PECUF";
  }

  // PECCUMP (10%)
  if (detalle.PECCUMP && detalle.PECCUMP.length > 0) {
    descuentos.PECCUMP = 10;
    nota -= descuentos.PECCUMP;
    // Si no hay PENCUF/PECNEG/PECUF, tipo será PECCUMP
    if (tipo === "NINGUNO") {
      tipo = "PECCUMP";
    }
  }

  // Redondear a 1 decimal, mínimo 0
  nota = Math.max(0, Math.round(nota * 10) / 10);

  return {
    nota,
    tipo,
    detalle,
    descuentos
  };
}

/* --------------------- GUARDAR REGISTRO ---------------------- */
window.submitRecord = async function() {
  const msgEl = document.getElementById('msg');
  msgEl.style.color = 'green';
  msgEl.textContent = "⏳ Subiendo...";

  try {
    // ITEMS SELECCIONADOS
    const items = [...document.querySelectorAll(".item-block")].map(b=>{
      const [name, percStr, group] = b.querySelector("select").value.split("||");
      return {
        name,
        perc: Number(percStr),
        group,
        detail: b.querySelector("textarea").value || ""
      };
    });

    // CÁLCULO NOTA + DETALLE
    const calc = calcularNotaConDetalle(items);

    // IMÁGENES
    const files = document.getElementById('imgs').files;
    const imageURLs = [];

    for(const f of files){
      const storageRef = ref(storage, `monitoreo_imagenes/${Date.now()}_${f.name}`);
      await uploadBytes(storageRef, f);
      const url = await getDownloadURL(storageRef);
      imageURLs.push({name: f.name, url});
    }

    // OBJETO FINAL A GUARDAR
    const data = {
      idLlamada: idLlamada.value,
      idContacto: idContacto.value,
      tipo: tipoDetectado.value,
      asesor: asesor.value,
      cargo: cargo.value,
      cliente:{
        dni: cliDni.value,
        nombre: cliNombre.value,
        tel: cliTel.value
      },
      tipificacion: cliTipif.value,
      observacionCliente: cliObs.value,
      resumen: resumen.value,
      items,
      imagenes: imageURLs,
      nota: calc.nota,
      calculo: {
        tipo: calc.tipo,
        detalle: calc.detalle,
        descuentos: calc.descuentos
      },
      fecha: new Date().toISOString(),
      estado: "PENDIENTE"
    };

    const newDoc = await addDoc(collection(db, "registros"), data);

    msgEl.style.color = 'green';
    msgEl.textContent = "✔ Guardado correctamente (ID: " + newDoc.id + ")";

    clearItems();
    document.getElementById('imgPreview').innerHTML = "";
    document.getElementById('imgs').value = "";

  } catch(err){
    msgEl.style.color = 'red';
    msgEl.textContent = "❌ Error: " + err.message;
    console.error(err);
  }
}
</script>

</body>
</html>

