<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Validaci√≥n final refuerzos</title>
</head>
<body>
  <h2>Validaci√≥n FINAL de Refuerzos</h2>
  <button id="run">Ejecutar validaci√≥n definitiva</button>
  <pre id="log"></pre>

  <script type="module">
    import { db } from "./js/firebase.js";
    import {
      collection,
      getDocs,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const log = msg =>
      document.getElementById("log").textContent += msg + "\n";

    document.getElementById("run").onclick = async () => {
      log("üîç Buscando L√≠der de Calidad activo...");

      const regSnap = await getDocs(collection(db, "registradores"));
      const lider = regSnap.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .find(r =>
          r.activo === true &&
          r.cargo === "L√≠der de Calidad y Formaci√≥n" &&
          r.firmaUrl
        );

      if (!lider) {
        log("‚ùå ERROR: No hay L√≠der de Calidad activo con firma");
        return;
      }

      log("‚úÖ L√≠der encontrado: " + lider.registradoPorNombre);

      const refSnap = await getDocs(collection(db, "refuerzos_calidad"));
      let corregidos = 0;

      for (const d of refSnap.docs) {
        const ref = d.data();

        const needsFix =
          !ref.responsableFirmaUrl ||
          !ref.responsableNombre ||
          !ref.responsableCargo ||
          !ref.responsableId;

        if (!needsFix) continue;

        await updateDoc(doc(db, "refuerzos_calidad", d.id), {
          responsable: `${lider.registradoPorNombre} - ${lider.cargo}`,
          responsableId: lider.id,
          responsableNombre: lider.registradoPorNombre,
          responsableCargo: lider.cargo,
          responsableFirmaUrl: lider.firmaUrl
        });

        corregidos++;
        log("üõ†Ô∏è Corregido: " + d.id);
      }

      log("‚úÖ VALIDACI√ìN COMPLETA");
      log("Total corregidos: " + corregidos);
      log("üëâ Firestore est√° ahora 100% consistente");
    };
  </script>
</body>
</html>
