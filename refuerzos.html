<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Refuerzos & Capacitaciones ‚Äì Calidad FE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #f3f4f6;
            --bg-soft: #e5e7eb;
            --text: #111827;
            --muted: #6b7280;
            --card: #ffffff;
            --accent: #0f4c81;
            --accent-soft: #2563eb;
            --border: #e5e7eb;
            --shadow: 0 18px 45px rgba(15, 23, 42, 0.16);
            --success: #16a34a;
            --warning: #f97316;
            --danger: #dc2626;
            --chip-bg: #e5f0ff
        }

        body.dark {
            --bg: #020617;
            --bg-soft: #020617;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --card: #020617;
            --accent: #38bdf8;
            --accent-soft: #0ea5e9;
            --border: #1f2937;
            --shadow: 0 22px 60px rgba(0, 0, 0, 0.85);
            --chip-bg: #0f172a
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at top, rgba(37, 99, 235, 0.12), transparent 55%), var(--bg);
            color: var(--text);
            min-height: 100vh
        }

        header {
            backdrop-filter: blur(14px);
            background: linear-gradient(to right, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.92));
            color: #e5e7eb;
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 20
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .header-title span.logo {
            width: 26px;
            height: 26px;
            border-radius: 9px;
            background: linear-gradient(135deg, #22c55e, #0ea5e9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            color: #0b1120
        }

        .header-sub {
            font-size: 12px;
            color: #9ca3af
        }

        .header-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px
        }

        .pill {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(15, 23, 42, 0.3);
            display: flex;
            align-items: center;
            gap: 6px
        }

        .pill-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #22c55e
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .btn-sm,
        .btn-toggle {
            border: none;
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 12px;
            cursor: pointer;
            background: rgba(15, 23, 42, 0.85);
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(148, 163, 184, 0.6)
        }

        .container {
            max-width: 1180px;
            margin: 0 auto;
            padding: 18px 16px 32px
        }

        .layout-grid {
            display: grid;
            grid-template-columns: minmax(1fr) minmax(1fr);
            gap: 10px;
            margin-top: 5px
        }

        @media(max-width:960px) {
            .layout-grid {
                grid-template-columns: 1fr
            }
        }

        .card {
            background: var(--card);
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.26);
            box-shadow: var(--shadow);
            padding: 18px 18px 20px;
            position: relative;
            overflow: hidden
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 12px
        }

        .card-title {
            font-size: 15px;
            font-weight: 600
        }

        .card-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px
        }

        .chip {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            background: var(--chip-bg);
            color: var(--accent-soft);
            border: 1px solid rgba(148, 163, 184, 0.4)
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 10px 12px;
            margin-top: 6px
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px 9px;
            border-radius: 9px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            outline: none;
            resize: vertical;
            min-height: 38px
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--accent-soft);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.40);
            background: var(--card)
        }

        .form-footer {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap
        }

        .hint {
            font-size: 11px;
            color: var(--muted)
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 9px 16px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--accent-soft), #0ea5e9);
            color: #f9fafb;
            box-shadow: 0 14px 35px rgba(37, 99, 235, 0.42);
            transition: .15s
        }

        .btn:hover {
            transform: translateY(-1px)
        }

        .btn-secondary {
            background: transparent;
            color: var(--muted);
            border: 1px dashed var(--border);
            box-shadow: none
        }

        .badge-inline {
            font-size: 11px;
            padding: 3px 7px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: var(--muted);
            display: inline-flex;
            align-items: center;
            gap: 4px
        }

        .badge-dot-success,
        .badge-dot-warning {
            width: 7px;
            height: 7px;
            border-radius: 999px
        }

        .badge-dot-success {
            background: var(--success)
        }

        .badge-dot-warning {
            background: var(--warning)
        }

        .chips-wrapper {
            grid-column: 1/-1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 4px
        }

        .chips-label-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 8px
        }

        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .asesor-chip {
            border: 1px solid var(--border);
            background: var(--bg-soft);
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.10);
            border-radius: 14px;
            padding: 10px 12px;
            min-width: 210px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 2px;
            text-align: left;
            font-size: 13px;
            transition: 0.15s ease
        }

        .asesor-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.18)
        }

        .asesor-chip.selected {
            border-color: var(--accent-soft);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(56, 189, 248, 0.08));
            box-shadow: 0 16px 40px rgba(37, 99, 235, 0.35)
        }

        .asesor-chip-name {
            font-weight: 600
        }

        .asesor-chip-gc {
            font-size: 11px;
            color: var(--muted)
        }

        .metrics-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px
        }

        .metric-pill {
            font-size: 11px;
            padding: 5px 9px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(148, 163, 184, 0.06);
            display: inline-flex;
            align-items: center;
            gap: 6px
        }

        .metric-value {
            font-weight: 600
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px
        }

        .filters-row>* {
            flex: 1;
            min-width: 150px
        }

        .filters-row .compact {
            max-width: 160px;
            flex: 0 0 auto
        }

        .search-input {
            padding: 8px 11px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg);
            font-size: 13px
        }

        .table-wrapper {
            margin-top: 6px;
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            background: linear-gradient(to bottom, rgba(148, 163, 184, 0.06), transparent)
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px
        }

        th,
        td {
            padding: 8px 9px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            vertical-align: top
        }

        tr:hover td {
            background: rgba(148, 163, 184, 0.06)
        }

        .estado-pill {
            font-size: 11px;
            padding: 3px 7px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 5px
        }

        .estado-ok {
            background: rgba(22, 163, 74, 0.08);
            color: var(--success);
            border: 1px solid rgba(22, 163, 74, 0.30)
        }

        .estado-pend {
            background: rgba(249, 115, 22, 0.08);
            color: var(--warning);
            border: 1px solid rgba(249, 115, 22, 0.30)
        }

        .estado-incomp {
            background: rgba(220, 38, 38, 0.08);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.30)
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: rgba(148, 163, 184, 0.16);
            color: var(--text)
        }

        .btn-xs.primary {
            background: rgba(37, 99, 235, 0.18)
        }

        .btn-xs.success {
            background: rgba(22, 163, 74, 0.16);
            color: var(--success)
        }

        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.70);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            color: #e5e7eb;
            font-size: 13px;
            flex-direction: column;
            gap: 10px
        }

        .loader-bar {
            width: 190px;
            height: 4px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.45);
            overflow: hidden
        }

        .loader-bar-inner {
            width: 40%;
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, #38bdf8, #22c55e);
            animation: loading 1.05s infinite
        }

        @keyframes loading {
            0% {
                transform: translateX(-100%)
            }

            50% {
                transform: translateX(30%)
            }

            100% {
                transform: translateX(200%)
            }
        }

        @media(max-width:720px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px
            }

            .header-right {
                align-self: stretch;
                justify-content: flex-end
            }
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60
        }

        .modal-content {
            background: var(--card);
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 22px 60px rgba(15, 23, 42, 0.85);
            max-width: 900px;
            width: 96%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden
        }

        .modal-header {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(to right, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
            color: #e5e7eb;
            font-size: 14px;
            font-weight: 600
        }

        .modal-close {
            border: none;
            background: transparent;
            color: #9ca3af;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
            border-radius: 999px
        }

        .modal-close:hover {
            background: rgba(148, 163, 184, 0.16);
            color: #e5e7eb
        }

        .modal-body {
            padding: 12px;
            flex: 1;
            background: #111827;
            overflow: auto
        }

        .modal-footer {
            padding: 10px 14px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background: var(--bg-soft)
        }

        .pdf-content {
            width: 100%;
            max-width: 800px;
            margin: 0 auto 8px;
            background: #ffffff;
            color: #111827;
            padding: 24px 32px;
            border-radius: 12px;
            box-shadow: 0 0 0 1px #e5e7eb;
            font-size: 13px;
            line-height: 1.5
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px
        }

        .pdf-title-block {
            flex: 1
        }

        .pdf-main-title {
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase
        }

        .pdf-subtitle {
            font-size: 12px;
            color: #4b5563;
            margin-top: 2px
        }

        .pdf-badge-fe {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            color: #2563eb
        }

        .pdf-section-title {
            font-weight: 600;
            margin-top: 14px;
            margin-bottom: 4px;
            font-size: 13px;
            text-transform: uppercase
        }

        .pdf-section-body {
            margin-left: 4px;
            font-size: 13px
        }

        .pdf-field-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin: 2px 0
        }

        .pdf-field {
            font-size: 13px
        }

        .pdf-objective-box,
        .pdf-detail-box {
            margin-top: 4px;
            padding: 8px 10px;
            border-radius: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            font-size: 13px
        }

        .pdf-signatures {
            margin-top: 24px;
            display: flex;
            gap: 20px;
            align-items: flex-start
        }

        .pdf-sign-resp {
            flex: 0 0 220px;
            text-align: center;
            font-size: 12px
        }

        .pdf-sign-resp-title {
            font-weight: 600;
            margin-bottom: 4px
        }

        .pdf-sign-resp img {
            max-width: 200px;
            max-height: 70px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            background: #ffffff
        }

        .pdf-sign-resp-line {
            border-top: 1px solid #111827;
            margin: 10px 0 4px
        }

        .pdf-sign-resp-role {
            color: #6b7280
        }

        .pdf-sign-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 10px
        }

        .pdf-sign-card {
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 6px 8px;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .pdf-sign-card-header {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            align-items: baseline
        }

        .pdf-sign-name {
            font-weight: 600;
            font-size: 12px
        }

        .pdf-sign-gc {
            color: #6b7280;
            font-size: 10px
        }

        .pdf-sign-status {
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 10px;
            border: 1px solid #e5e7eb;
            background: #eef2ff;
            color: #1d4ed8;
            white-space: nowrap
        }

        .pdf-sign-status-ok {
            background: #dcfce7;
            border-color: #22c55e;
            color: #15803d
        }

        .pdf-sign-img {
            margin-top: 2px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden
        }

        .pdf-sign-img img {
            max-height: 58px;
            width: 100%;
            object-fit: contain
        }

        .pdf-sign-img-empty {
            font-size: 10px;
            color: #9ca3af;
            border-style: dashed;
            background: #f3f4f6
        }

        .pdf-sign-date {
            margin-top: 2px;
            font-size: 10px;
            color: #6b7280
        }
    </style>
</head>

<body>
    <header>
        <div class="header-left">
            <div class="header-title"><span class="logo">FE</span>Refuerzos & Capacitaciones</div>
            <div class="header-sub">Registro oficial de acciones de Calidad & Formaci√≥n ‚Äì Financiera Efectiva.</div>
            <div class="header-meta">
                <div class="pill"><span class="pill-dot"></span>M√≥dulo interno de Calidad</div>
                <div class="pill">Responsable: Alex Paolo Nu√±ez Sulca ‚Äì L√≠der de Calidad y Formaci√≥n</div>
            </div>
        </div>
        <div class="header-right"><button id="btnIrBuscador" class="btn-sm">üîé Ir al Dashboard</button><button id="themeToggle" class="btn-toggle">üåô Modo oscuro</button></div>
    </header>
    <div class="container">
        <div class="layout-grid">
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Nuevo refuerzo / capacitaci√≥n</div>
                        <div class="card-sub">Registra solo acciones formales de refuerzo, feedback o capacitaci√≥n asociadas a Calidad.</div>
                    </div><span class="chip">Solo Calidad & Formaci√≥n</span>
                </div>
                <div class="form-grid">
                    <div><label>Fecha del refuerzo</label><input type="date" id="fecha"></div>
                    <div><label>Tipo de acci√≥n</label><select id="tipo">
                            <option value="">Seleccione</option>
                            <option>Capacitaci√≥n grupal</option>
                            <option>Refuerzo 1:1</option>
                            <option>Feedback de calidad</option>
                            <option>Recordatorio normativo</option>
                            <option>Coaching / role play</option>
                        </select></div>
                    <div><label>Tema / t√≠tulo</label><input id="tema" placeholder="Ej. Manejo de objeciones SBS / Script de bienvenida"></div>
                    <div><label>Canal</label><select id="canal">
                            <option value="">Seleccione</option>
                            <option>Presencial</option>
                            <option>Teams</option>
                            <option>Llamada</option>
                            <option>Otro</option>
                        </select></div>
                    <div class="chips-wrapper">
                        <div class="chips-label-row"><span class="hint"><b>Asesores capacitados</b> (selecci√≥n m√∫ltiple)</span><span class="hint">Datos en tiempo real desde colecci√≥n <b>asesores</b></span></div>
                        <div id="asesoresContainer" class="chips-container"></div>
                    </div>
                    <div><label>Responsable</label><input id="responsable" value="Alex Paolo Nu√±ez Sulca - L√≠der de Calidad y Formaci√≥n" readonly></div>
                </div>
                <div style="margin-top:10px;"><label>Objetivo del refuerzo</label><textarea id="objetivo" rows="2" placeholder="Ej. Reforzar cumplimiento SBS en fase de ofrecimiento, reducir errores de cierre, etc."></textarea></div>
                <div style="margin-top:10px;"><label>Detalle / acuerdos clave</label><textarea id="detalle" rows="3" placeholder="Puntos espec√≠ficos tratados, compromisos, indicadores a monitorear, etc."></textarea></div>
                <div class="form-footer">
                    <div class="hint">
                        <div>‚úî Luego el agente podr√° firmar este refuerzo desde <b>portal_agente.html</b>.</div>
                        <div>‚úî El PDF se genera desde aqu√≠ con las firmas de Alex + agentes.</div>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;"><button class="btn-secondary" type="button" id="btnLimpiar">Limpiar</button><button class="btn" type="button" id="btnGuardar">üíæ Guardar refuerzo</button></div>
                </div>
            </section>
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Historial de refuerzos</div>
                        <div class="card-sub">Vista ejecutiva del avance de firmas y estado de cada acci√≥n de calidad.</div>
                    </div>
                </div>
                <div class="metrics-row">
                    <div class="metric-pill">Total refuerzos: <span class="metric-value" id="metricTotal">0</span></div>
                    <div class="metric-pill">Firmados: <span class="metric-value" id="metricFirmados">0</span></div>
                    <div class="metric-pill">Pendientes de firma: <span class="metric-value" id="metricPendientes">0</span></div>
                </div>
                <div class="filters-row"><input id="searchTabla" class="search-input" placeholder="Buscar por agente, tema, tipo, p√∫blico‚Ä¶"><select id="filtroEstado" class="compact">
                        <option value="todos">Estado: todos</option>
                        <option value="pendiente">Pendiente de firma</option>
                        <option value="firmado">Firmado</option>
                        <option value="incompleto">Datos incompletos</option>
                    </select></div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tema / Tipo</th>
                                <th>P√∫blico</th>
                                <th>Firma</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaRefuerzos"></tbody>
                    </table>
                </div>
                <div style="margin-top:8px;font-size:11px;color:var(--muted);display:flex;justify-content:space-between;gap:6px;flex-wrap:wrap;"><span class="badge-inline"><span class="badge-dot-success"></span> Firmado por agente</span><span class="badge-inline"><span class="badge-dot-warning"></span> Pendiente de firma / datos</span></div>
            </section>
        </div>
    </div>
    <div id="loadingOverlay">
        <div id="loadingText">Procesando‚Ä¶</div>
        <div class="loader-bar">
            <div class="loader-bar-inner"></div>
        </div>
    </div>
    <div id="pdfModal" class="modal-backdrop" style="display:none;">
        <div class="modal-content">
            <div class="modal-header"><span id="pdfModalTitle">Vista previa del refuerzo</span><button class="modal-close" onclick="cerrarModalPdf()">‚úï</button></div>
            <div class="modal-body">
                <div id="pdfContentRefuerzo" class="pdf-content"></div>
            </div>
            <div class="modal-footer"><button class="btn" type="button" onclick="descargarPdfActual()">‚¨á Descargar PDF</button><button class="btn-secondary" type="button" onclick="cerrarModalPdf()">Cerrar</button></div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            addDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyD4cFHDbSfJNAhTuuP01N5JZQd-FOYB2LM",
            authDomain: "feedback-app-ac30e.firebaseapp.com",
            projectId: "feedback-app-ac30e",
            storageBucket: "feedback-app-ac30e.firebasestorage.app",
            messagingSenderId: "512179147778",
            appId: "1:512179147778:web:795e4a8b177fe766d3431b",
            measurementId: "G-X6MP0FFH9P"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRefuerzos = collection(db, "refuerzos_calidad");
        const colAsesores = collection(db, "asesores");
        const FIRMA_ALEX_URL = "https://firebasestorage.googleapis.com/v0/b/feedback-app-ac30e.firebasestorage.app/o/firmas%2Ffirma_alex.png?alt=media&token=5081e2c6-8e5e-46e6-a340-c13cace95864";
        let refuerzosCache = [];
        let filtroTexto = "";
        let filtroEstado = "todos";
        let asesoresMap = {};
        let pdfActualId = null;

        function setLoading(show, text = "Procesando‚Ä¶") {
            const overlay = document.getElementById("loadingOverlay");
            const label = document.getElementById("loadingText");
            label.textContent = text;
            overlay.style.display = show ? "flex" : "none"
        }

        function setToday() {
            const inputFecha = document.getElementById("fecha");
            const hoy = new Date;
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, "0");
            const dd = String(hoy.getDate()).padStart(2, "0");
            inputFecha.value = `${yyyy}-${mm}-${dd}`
        }

        function formatearFechaLarga(fechaISO) {
            if (!fechaISO) return "-";
            const f = new Date(fechaISO);
            return f.toLocaleDateString("es-PE", {
                weekday: "long",
                day: "numeric",
                month: "long",
                year: "numeric"
            })
        }

        function formatearFechaCorta(fechaISO) {
            if (!fechaISO) return "-";
            return new Date(fechaISO).toLocaleDateString("es-PE")
        }

        function formatearFechaHora(fechaISO) {
            if (!fechaISO) return "";
            return new Date(fechaISO).toLocaleString("es-PE")
        }
        async function cargarAsesores() {
            const cont = document.getElementById("asesoresContainer");
            try {
                setLoading(!0, "Cargando asesores‚Ä¶");
                const snap = await getDocs(colAsesores);
                const lista = snap.docs.map(d => ({
                    id: d.id,
                    ...d.data()
                }));
                lista.sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""));
                asesoresMap = {};
                cont.innerHTML = "";
                lista.forEach(a => {
                    const id = a.id;
                    const nombre = a.nombre || "(sin nombre)";
                    const gc = a.GC || a.gc || "";
                    asesoresMap[id] = {
                        nombre,
                        gc
                    };
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "asesor-chip";
                    btn.dataset.id = id;
                    btn.innerHTML = `<span class="asesor-chip-name">${nombre}</span><span class="asesor-chip-gc">${gc?gc:"Sin GC"}</span>`;
                    btn.addEventListener("click", () => {
                        btn.classList.toggle("selected")
                    });
                    cont.appendChild(btn)
                })
            } catch (e) {
                console.error(e);
                cont.innerHTML = "<div class='hint'>Error cargando asesores</div>";
                alert("Error cargando asesores: " + e.message)
            } finally {
                setLoading(!1)
            }
        }
        async function cargarRefuerzos() {
            setLoading(!0, "Cargando refuerzos‚Ä¶");
            try {
                const snap = await getDocs(colRefuerzos);
                refuerzosCache = snap.docs.map(d => ({
                    id: d.id,
                    ...d.data()
                }));
                refuerzosCache.sort((a, b) => {
                    const fa = a.fechaRefuerzo ? new Date(a.fechaRefuerzo) : 0;
                    const fb = b.fechaRefuerzo ? new Date(b.fechaRefuerzo) : 0;
                    return fb - fa
                });
                renderTabla()
            } catch (e) {
                console.error(e);
                alert("Error cargando refuerzos: " + e.message)
            } finally {
                setLoading(!1)
            }
        }

        function esIncompleto(r) {
            return !r.fechaRefuerzo || !r.tipo || !r.tema || !r.publico || !r.objetivo
        }

        function filtrarLista() {
            const q = (filtroTexto || "").trim().toLowerCase();
            let lista = [...refuerzosCache];
            if (q) {
                lista = lista.filter(r => {
                    const join = [r.tema || "", r.tipo || "", r.publico || "", r.detalle || "", r.objetivo || "", r.responsable || "", r.agenteNombre || ""].join(" ").toLowerCase();
                    return join.includes(q)
                })
            }
            if (filtroEstado !== "todos") {
                lista = lista.filter(r => {
                    const incompleto = esIncompleto(r);
                    const firmado = !!r.firmado;
                    if (filtroEstado === "incompleto") return incompleto;
                    if (filtroEstado === "firmado") return firmado && !incompleto;
                    if (filtroEstado === "pendiente") return !firmado && !incompleto;
                    return !0
                })
            }
            return lista
        }

        function actualizarMetricas() {
            const total = refuerzosCache.length;
            const firmados = refuerzosCache.filter(r => r.firmado && !esIncompleto(r)).length;
            const pendientes = refuerzosCache.filter(r => !r.firmado && !esIncompleto(r)).length;
            document.getElementById("metricTotal").textContent = total;
            document.getElementById("metricFirmados").textContent = firmados;
            document.getElementById("metricPendientes").textContent = pendientes
        }

        function renderTabla() {
            const tbody = document.getElementById("tablaRefuerzos");
            const lista = filtrarLista();
            actualizarMetricas();
            if (!lista.length) {
                tbody.innerHTML = "<tr><td colspan='6'>Sin refuerzos registrados con los criterios actuales.</td></tr>";
                return
            }
            tbody.innerHTML = lista.map(r => {
                const fechaStr = r.fechaRefuerzo ? new Date(r.fechaRefuerzo).toLocaleDateString("es-PE") : "-";
                const incompleto = esIncompleto(r);
                const firmado = !!r.firmado;
                let estadoClase = "estado-pend";
                let estadoTexto = "Pendiente de firma";
                if (incompleto) {
                    estadoClase = "estado-incomp";
                    estadoTexto = "Datos incompletos"
                } else if (firmado) {
                    estadoClase = "estado-ok";
                    estadoTexto = "Firmado por agente"
                }
                const asesoresArr = Array.isArray(r.asesores) ? r.asesores : [];
                const firmasArr = Array.isArray(r.firmas) ? r.firmas : [];
                const totalA = asesoresArr.length;
                const firmadas = firmasArr.filter(f => f && f.url).length;
                const resumenFirmas = totalA ? `${firmadas}/${totalA} firmas` : r.firmaNombre || "‚Äî";
                const firmaFecha = r.firmaFecha ? new Date(r.firmaFecha).toLocaleString("es-PE") : totalA ? "Pendiente" : "";
                return `<tr><td>${fechaStr}</td><td><div style="font-weight:500">${r.tema||""}</div><div style="font-size:11px;color:var(--muted);">${r.tipo||""}</div></td><td>${r.publico||""}</td><td style="font-size:11px;"><div><b>${resumenFirmas}</b></div><div style="color:var(--muted);">${firmaFecha}</div></td><td><span class="estado-pill ${estadoClase}">${estadoTexto}</span></td><td><div class="actions"><button class="btn-xs primary" onclick="verPdf('${r.id}')">üìÑ Ver PDF</button><button class="btn-xs success" onclick="copiarLinkFirma('${r.id}')">‚úçÔ∏è Link firma</button></div></td></tr>`
            }).join("")
        }
        async function guardarRefuerzo() {
            const fechaInput = document.getElementById("fecha").value;
            const tipo = document.getElementById("tipo").value;
            const tema = document.getElementById("tema").value.trim();
            const canal = document.getElementById("canal").value;
            const responsable = document.getElementById("responsable").value;
            const objetivo = document.getElementById("objetivo").value.trim();
            const detalle = document.getElementById("detalle").value.trim();
            const chipsSeleccionados = Array.from(document.querySelectorAll(".asesor-chip.selected"));
            const asesoresSeleccionados = chipsSeleccionados.map(chip => {
                const id = chip.dataset.id;
                const info = asesoresMap[id];
                if (!info) return null;
                return {
                    asesorId: id,
                    nombre: info.nombre,
                    gc: info.gc || ""
                }
            }).filter(x => x);
            const publico = asesoresSeleccionados.map(a => a.nombre).join(", ");
            if (!fechaInput || !tipo || !tema || !objetivo) {
                alert("Completa al menos: Fecha, Tipo, Tema y Objetivo.");
                return
            }
            const fechaRefuerzo = new Date(fechaInput + "T00:00:00");
            const firmasIniciales = asesoresSeleccionados.map(a => ({
                asesorId: a.asesorId,
                nombre: a.nombre,
                gc: a.gc || "",
                url: "",
                fechaFirma: null,
                compromiso: ""
            }));
            const data = {
                fechaRefuerzo: fechaRefuerzo.toISOString(),
                tipo,
                tema,
                canal,
                publico,
                asesores: asesoresSeleccionados,
                responsable,
                objetivo,
                detalle,
                firmado: !1,
                firmaNombre: "",
                firmaFecha: null,
                agenteNombre: "",
                firmas: firmasIniciales,
                createdAt: serverTimestamp()
            };
            try {
                setLoading(!0, "Guardando refuerzo‚Ä¶");
                await addDoc(colRefuerzos, data);
                alert("Refuerzo registrado correctamente.");
                limpiarFormulario();
                await cargarRefuerzos()
            } catch (e) {
                console.error(e);
                alert("Error al guardar: " + e.message)
            } finally {
                setLoading(!1)
            }
        }

        function limpiarFormulario() {
            setToday();
            document.getElementById("tipo").value = "";
            document.getElementById("tema").value = "";
            document.getElementById("canal").value = "";
            document.getElementById("objetivo").value = "";
            document.getElementById("detalle").value = "";
            document.querySelectorAll(".asesor-chip.selected").forEach(ch => ch.classList.remove("selected"))
        }

        function construirTarjetasFirmas(ref) {
            const asesores = Array.isArray(ref.asesores) ? ref.asesores : [];
            const firmas = Array.isArray(ref.firmas) ? ref.firmas : [];
            return asesores.map(a => {
                const f = firmas.find(x => x.asesorId === a.asesorId) || {};
                const tieneFirma = !!f.url;
                const fechaFirmaTxt = f.fechaFirma ? formatearFechaHora(f.fechaFirma) : "Pendiente";
                const compromiso = f.compromiso || "<em>Sin compromiso registrado</em>";
                return `<div class="pdf-sign-card"><div class="pdf-sign-card-header"><div><div class="pdf-sign-name">${a.nombre}</div><div class="pdf-sign-gc">${a.gc?"GC: "+a.gc:""}</div></div><div class="${tieneFirma?"pdf-sign-status pdf-sign-status-ok":"pdf-sign-status"}">${tieneFirma?"Firmado":"Pendiente"}</div></div><div class="pdf-sign-img ${tieneFirma?"":"pdf-sign-img-empty"}">${tieneFirma?`<img src="${f.url}">`:"Sin firma registrada"}</div><div class="pdf-sign-date">${tieneFirma?"Firmado el: "+fechaFirmaTxt:""}</div><div style="margin-top:4px;"><b>Compromiso:</b><br>${compromiso}</div></div>`
            }).join("")
        }

        function renderPdfContent(ref) {
            const cont = document.getElementById("pdfContentRefuerzo");
            const fechaLarga = formatearFechaLarga(ref.fechaRefuerzo);
            const fechaCorta = formatearFechaCorta(ref.fechaRefuerzo);
            const asesores = Array.isArray(ref.asesores) ? ref.asesores : [];
            const listadoAsesores = asesores.length ? asesores.map(a => `${a.nombre} ${a.gc?"("+a.gc+")":""}`).join(", ") : ref.publico || "‚Äî";
            cont.innerHTML = `<div class="pdf-header"><div class="pdf-title-block"><div class="pdf-main-title">REFUERZO / CAPACITACI√ìN</div><div class="pdf-subtitle">Registro formal de acciones de Calidad & Formaci√≥n ‚Äì Financiera Efectiva.</div></div><div><div class="pdf-badge-fe">Calidad & Formaci√≥n FE</div></div></div><div class="pdf-section-body"><div class="pdf-field-row"><div class="pdf-field"><b>Fecha del refuerzo:</b> ${fechaLarga}</div><div class="pdf-field"><b>Fecha corta:</b> ${fechaCorta}</div></div><div class="pdf-field-row"><div class="pdf-field"><b>Tipo de acci√≥n:</b> ${ref.tipo||"‚Äî"}</div><div class="pdf-field"><b>Canal:</b> ${ref.canal||"‚Äî"}</div></div><div class="pdf-field-row"><div class="pdf-field"><b>Tema / t√≠tulo:</b> ${ref.tema||"‚Äî"}</div></div><div class="pdf-field-row" style="margin-top:4px;"><div class="pdf-field"><b>Responsable:</b> ${ref.responsable||"‚Äî"}</div></div></div><div class="pdf-section-title">Asesores capacitados</div><div class="pdf-section-body"><div class="pdf-objective-box">${listadoAsesores}</div></div><div class="pdf-section-title">Objetivo del refuerzo</div><div class="pdf-section-body"><div class="pdf-objective-box">${ref.objetivo||"‚Äî"}</div></div><div class="pdf-section-title">Detalle / acuerdos clave</div><div class="pdf-section-body"><div class="pdf-detail-box">${ref.detalle||"‚Äî"}</div></div><div class="pdf-section-title">Firmas</div><div class="pdf-section-body"><div class="pdf-signatures"><div class="pdf-sign-resp"><div class="pdf-sign-resp-title">Responsable de Calidad</div><div class="pdf-sign-img"><img src="${FIRMA_ALEX_URL}"></div><div class="pdf-sign-resp-line"></div><div><strong>Alex Paolo Nu√±ez Sulca</strong></div><div class="pdf-sign-resp-role">L√≠der de Calidad y Formaci√≥n</div></div><div class="pdf-sign-grid">${construirTarjetasFirmas(ref)}</div></div></div>`
        }

        function abrirModalPdf(id) {
            pdfActualId = id;
            const modal = document.getElementById("pdfModal");
            const ref = refuerzosCache.find(x => x.id === id);
            document.getElementById("pdfModalTitle").textContent = `Vista previa del refuerzo (${id})`;
            if (ref) {
                renderPdfContent(ref)
            } else {
                document.getElementById("pdfContentRefuerzo").innerHTML = "<p>No se encontr√≥ informaci√≥n del refuerzo.</p>"
            }
            modal.style.display = "flex"
        }
        window.cerrarModalPdf = function() {
            document.getElementById("pdfModal").style.display = "none"
        };
window.descargarPdfActual = async function() {
    if (!pdfActualId) return alert("No hay refuerzo seleccionado");

    const original = document.getElementById("pdfContentRefuerzo");

    // --- Crear copia en un contenedor fuera del modal ---
    const temp = original.cloneNode(true);
    temp.style.position = "absolute";
    temp.style.top = "-9999px";
    temp.style.left = "-9999px";
    temp.style.background = "#ffffff";
    document.body.appendChild(temp);

    // Esperar carga de im√°genes
    const imgs = temp.querySelectorAll("img");
    await Promise.all(
        Array.from(imgs).map(img => new Promise(resolve => {
            if (img.complete) resolve();
            else img.onload = img.onerror = resolve;
        }))
    );

    const opt = {
        margin: 10,
        filename: `refuerzo_${pdfActualId}.pdf`,
        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };

    await html2pdf().set(opt).from(temp).save();

    // Eliminar copia temporal
    temp.remove();
};

        window.verPdf = function(id) {
            abrirModalPdf(id)
        };
        window.copiarLinkFirma = async function(id) {
            try {
                const base = window.location.origin === "null" ? "" : window.location.origin;
                const url = base ? `${base}/portal_agente.html?id=${id}` : `portal_agente.html?id=${id}`;
                await navigator.clipboard.writeText(url);
                alert("Link de firma copiado:\n" + url)
            } catch (e) {
                alert("No se pudo copiar. URL:\nportal_agente.html?id=" + id)
            }
        };
        document.getElementById("searchTabla").addEventListener("input", e => {
            filtroTexto = e.target.value || "";
            renderTabla()
        });
        document.getElementById("filtroEstado").addEventListener("change", e => {
            filtroEstado = e.target.value;
            renderTabla()
        });
        document.getElementById("btnIrBuscador").onclick = () => {
            window.location.href = "index.html"
        };
        const themeBtn = document.getElementById("themeToggle");

        function applyTheme(theme) {
            const body = document.body;
            if (theme === "dark") {
                body.classList.add("dark");
                themeBtn.textContent = "‚òÄÔ∏è Modo claro"
            } else {
                body.classList.remove("dark");
                themeBtn.textContent = "üåô Modo oscuro"
            }
        }
        const savedTheme = localStorage.getItem("fe_refuerzos_theme") || "light";
        applyTheme(savedTheme);
        themeBtn.onclick = () => {
            const next = document.body.classList.contains("dark") ? "light" : "dark";
            localStorage.setItem("fe_refuerzos_theme", next);
            applyTheme(next)
        };
        setToday();
        await cargarAsesores();
        await cargarRefuerzos();
        document.getElementById("btnGuardar").onclick = guardarRefuerzo;
        document.getElementById("btnLimpiar").onclick = limpiarFormulario;
    </script>
</body>

</html>
