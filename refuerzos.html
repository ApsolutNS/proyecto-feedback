<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Refuerzos & Capacitaciones ‚Äì Calidad FE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ===============================
         ESTILO ULTRA CORPORATIVO
    ================================= -->
    <style>
        :root {
            --bg: #f3f4f6;
            --bg-soft: #e5e7eb;
            --text: #111827;
            --muted: #6b7280;
            --card: #ffffff;
            --accent: #0f4c81;
            --accent-soft: #2563eb;
            --border: #e5e7eb;
            --shadow: 0 18px 45px rgba(15, 23, 42, 0.16);
            --success: #16a34a;
            --warning: #f97316;
            --danger: #dc2626;
            --chip-bg: #e5f0ff;
        }
        body.dark {
            --bg: #020617;
            --bg-soft: #020617;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --card: #020617;
            --accent: #38bdf8;
            --accent-soft: #0ea5e9;
            --border: #1f2937;
            --shadow: 0 22px 60px rgba(0, 0, 0, 0.85);
            --chip-bg: #0f172a;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }
        body {
            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at top, rgba(37, 99, 235, 0.12), transparent 55%), var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        /* HEADER */
        header {
            backdrop-filter: blur(14px);
            background: linear-gradient(to right, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.92));
            color: #e5e7eb;
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .header-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-title span.logo {
            width: 26px;
            height: 26px;
            border-radius: 9px;
            background: linear-gradient(135deg, #22c55e, #0ea5e9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            color: #0b1120;
        }
        .header-sub {
            font-size: 12px;
            color: #9ca3af;
        }
        .header-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }
        .pill {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(15, 23, 42, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .pill-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #22c55e;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-sm {
            border: none;
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 12px;
            cursor: pointer;
            background: rgba(15, 23, 42, 0.8);
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(148, 163, 184, 0.6);
        }
        .btn-primary-sm {
            background: linear-gradient(135deg, var(--accent-soft), #0ea5e9);
            border: none;
            color: #f9fafb;
        }
        .btn-toggle {
            border: none;
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 12px;
            cursor: pointer;
            background: rgba(15, 23, 42, 0.85);
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(148, 163, 184, 0.6);
        }
        /* LAYOUT */
        .container {
            max-width: 1180px;
            margin: 0 auto;
            padding: 18px 16px 32px;
        }
        .layout-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
            gap: 18px;
            margin-top: 12px;
        }
        @media(max-width:960px) {
            .layout-grid {
                grid-template-columns: 1fr;
            }
        }
        /* CARD GEN√âRICA */
        .card {
            background: var(--card);
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.26);
            box-shadow: var(--shadow);
            padding: 18px 18px 20px;
            position: relative;
            overflow: hidden;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 12px;
        }
        .card-title {
            font-size: 15px;
            font-weight: 600;
        }
        .card-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px;
        }
        .chip {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            background: var(--chip-bg);
            color: var(--accent-soft);
            border: 1px solid rgba(148, 163, 184, 0.4);
        }
        /* FORM */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 10px 12px;
            margin-top: 6px;
        }
        label {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            display: block;
        }
        input,
        select,
        textarea {
            width: 100%;
            padding: 8px 9px;
            border-radius: 9px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            outline: none;
            resize: vertical;
            min-height: 38px;
        }
        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--accent-soft);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.40);
            background: var(--card);
        }
        .form-footer {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .hint {
            font-size: 11px;
            color: var(--muted);
        }
        .btn {
            border: none;
            border-radius: 999px;
            padding: 9px 16px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--accent-soft), #0ea5e9);
            color: #f9fafb;
            box-shadow: 0 14px 35px rgba(37, 99, 235, 0.42);
            transition: .15s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: transparent;
            color: var(--muted);
            border: 1px dashed var(--border);
            box-shadow: none;
        }
        .badge-inline {
            font-size: 11px;
            padding: 3px 7px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: var(--muted);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .badge-dot-success {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: var(--success);
        }
        .badge-dot-warning {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: var(--warning);
        }
        /* MULTI SELECT ASESOR */
        .checkbox-list {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 10px;
            max-height: 180px;
            overflow-y: auto;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
            font-size: 13px;
        }
        
        .checkbox-item input {
            transform: scale(1.1);
        }
        /* DASHBOARD + FILTROS */
        .metrics-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }
        .metric-pill {
            font-size: 11px;
            padding: 5px 9px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(148, 163, 184, 0.06);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .metric-value {
            font-weight: 600;
        }
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }
        .filters-row>* {
            flex: 1;
            min-width: 150px;
        }
        .filters-row .compact {
            max-width: 160px;
            flex: 0 0 auto;
        }
        .search-input {
            padding: 8px 11px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg);
            font-size: 13px;
        }
        /* TABLE */
        .table-wrapper {
            margin-top: 6px;
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            background: linear-gradient(to bottom, rgba(148, 163, 184, 0.06), transparent);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th,
        td {
            padding: 8px 9px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            vertical-align: top;
        }
        th {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: .05em;
            color: var(--muted);
            background: rgba(15, 23, 42, 0.03);
        }
        tr:hover td {
            background: rgba(148, 163, 184, 0.06);
        }
        .estado-pill {
            font-size: 11px;
            padding: 3px 7px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .estado-ok {
            background: rgba(22, 163, 74, 0.08);
            color: var(--success);
            border: 1px solid rgba(22, 163, 74, 0.30);
        }
        .estado-pend {
            background: rgba(249, 115, 22, 0.08);
            color: var(--warning);
            border: 1px solid rgba(249, 115, 22, 0.30);
        }
        .estado-incomp {
            background: rgba(220, 38, 38, 0.08);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.30);
        }
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .btn-xs {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: rgba(148, 163, 184, 0.16);
            color: var(--text);
        }
        .btn-xs.primary {
            background: rgba(37, 99, 235, 0.18);
        }
        .btn-xs.success {
            background: rgba(22, 163, 74, 0.16);
            color: var(--success);
        }
        /* OVERLAY CARGA */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.70);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            color: #e5e7eb;
            font-size: 13px;
            flex-direction: column;
            gap: 10px;
        }
        .loader-bar {
            width: 190px;
            height: 4px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.45);
            overflow: hidden;
        }
        .loader-bar-inner {
            width: 40%;
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, #38bdf8, #22c55e);
            animation: loading 1.05s infinite;
        }
        @keyframes loading {
            0% {
                transform: translateX(-100%);
            }
            50% {
                transform: translateX(30%);
            }
            100% {
                transform: translateX(200%);
            }
        }
        @media(max-width:720px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .header-right {
                align-self: stretch;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <div class="header-title">
                <span class="logo">FE</span>
                Refuerzos & Capacitaciones
            </div>
            <div class="header-sub">
                Registro oficial de acciones de Calidad & Formaci√≥n ‚Äì Financiera Efectiva.
            </div>
            <div class="header-meta">
                <div class="pill">
                    <span class="pill-dot"></span>
                    M√≥dulo interno de Calidad
                </div>
                <div class="pill">Responsable: Alex Paolo Nu√±ez Sulca ‚Äì L√≠der de Calidad y Formaci√≥n</div>
            </div>
        </div>
        <div class="header-right">
            <button id="btnIrBuscador" class="btn-sm">üîé Ir al buscador FE</button>
            <button id="btnIrAdmin" class="btn-primary-sm">üõ†Ô∏è Admin KB</button>
            <button id="themeToggle" class="btn-toggle">üåô Modo oscuro</button>
        </div>
    </header>

    <div class="container">
        <div class="layout-grid">
            <!-- =========================
                 CARD FORMULARIO
            ========================== -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Nuevo refuerzo / capacitaci√≥n</div>
                        <div class="card-sub">
                            Registra solo acciones formales de refuerzo, feedback o capacitaci√≥n asociadas a Calidad.
                        </div>
                    </div>
                    <span class="chip">Solo Calidad & Formaci√≥n</span>
                </div>
                <div class="form-grid">
                    <div>
                        <label>Fecha del refuerzo</label>
                        <input type="date" id="fecha">
                    </div>
                    <div>
                        <label>Tipo de acci√≥n</label>
                        <select id="tipo">
                            <option value="">Seleccione</option>
                            <option>Capacitaci√≥n grupal</option>
                            <option>Refuerzo 1:1</option>
                            <option>Feedback de calidad</option>
                            <option>Recordatorio normativo</option>
                            <option>Coaching / role play</option>
                        </select>
                    </div>
                    <div>
                        <label>Tema / t√≠tulo</label>
                        <input id="tema" placeholder="Ej. Manejo de objeciones SBS / Script de bienvenida">
                    </div>
                    <div>
                        <label>Canal</label>
                        <select id="canal">
                            <option value="">Seleccione</option>
                            <option>Presencial</option>
                            <option>Teams</option>
                            <option>Llamada</option>
                            <option>Otro</option>
                        </select>
                    </div>

                    <!-- === ASESOR(ES) DESDE FIRESTORE === -->
                   <div>
                        <label>Asesores capacitados</label>
                        <div id="asesoresContainer" class="chips-container">
                            <!-- Se llenar√° desde JS -->
                        </div>
                        <div class="hint" style="margin-top:4px;">
                            Selecciona uno o varios asesores. Datos desde colecci√≥n <b>asesores</b>.
                        </div>
                    </div>

                    </div>
                    <div>
                        <label>Responsable</label>
                        <input id="responsable" value="Alex Paolo Nu√±ez Sulca - L√≠der de Calidad y Formaci√≥n" readonly>
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label>Objetivo del refuerzo</label>
                    <textarea id="objetivo" rows="2" placeholder="Ej. Reforzar cumplimiento SBS en fase de ofrecimiento, reducir errores de cierre, etc."></textarea>
                </div>
                <div style="margin-top:10px;">
                    <label>Detalle / acuerdos clave</label>
                    <textarea id="detalle" rows="3" placeholder="Puntos espec√≠ficos tratados, compromisos, indicadores a monitorear, etc."></textarea>
                </div>
                <div class="form-footer">
                    <div class="hint">
                        <div>‚úî Luego el agente podr√° firmar este refuerzo desde <b>portal_agente.html</b>.</div>
                        <div>‚úî El PDF se genera con el formato de <b>visualizacion_feedback.html</b>.</div>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn-secondary" type="button" id="btnLimpiar">Limpiar</button>
                        <button class="btn" type="button" id="btnGuardar" onclick="guardarRefuerzo()">üíæ Guardar refuerzo</button>
                    </div>
                </div>
            </section>

            <!-- =========================
                 CARD LISTADO / ESTADO
            ========================== -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Historial de refuerzos</div>
                        <div class="card-sub">
                            Vista ejecutiva del avance de firmas y estado de cada acci√≥n de calidad.
                        </div>
                    </div>
                </div>
                <div class="metrics-row">
                    <div class="metric-pill">
                        Total refuerzos:
                        <span class="metric-value" id="metricTotal">0</span>
                    </div>
                    <div class="metric-pill">
                        Firmados:
                        <span class="metric-value" id="metricFirmados">0</span>
                    </div>
                    <div class="metric-pill">
                        Pendientes de firma:
                        <span class="metric-value" id="metricPendientes">0</span>
                    </div>
                </div>
                <div class="filters-row">
                    <input id="searchTabla" class="search-input" placeholder="Buscar por agente, tema, tipo, p√∫blico‚Ä¶">
                    <select id="filtroEstado" class="compact">
                        <option value="todos">Estado: todos</option>
                        <option value="pendiente">Pendiente de firma</option>
                        <option value="firmado">Firmado</option>
                        <option value="incompleto">Datos incompletos</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tema / Tipo</th>
                                <th>P√∫blico</th>
                                <th>Firma</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaRefuerzos"></tbody>
                    </table>
                </div>
                <div style="margin-top:8px;font-size:11px;color:var(--muted);display:flex;justify-content:space-between;gap:6px;flex-wrap:wrap;">
                    <span class="badge-inline">
                        <span class="badge-dot-success"></span> Firmado por agente
                    </span>
                    <span class="badge-inline">
                        <span class="badge-dot-warning"></span> Pendiente de firma / datos
                    </span>
                </div>
            </section>
        </div>
    </div>

    <!-- OVERLAY CARGA -->
    <div id="loadingOverlay">
        <div id="loadingText">Procesando‚Ä¶</div>
        <div class="loader-bar">
            <div class="loader-bar-inner"></div>
        </div>
    </div>

    <!-- ========== FIREBASE + L√ìGICA ========== -->
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            addDoc,
            doc,
            updateDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        /* ----------------- FIREBASE CONFIG ----------------- */
       const firebaseConfig = {
          apiKey: "AIzaSyD4cFHDbSfJNAhTuuP01N5JZQd-FOYB2LM",
          authDomain: "feedback-app-ac30e.firebaseapp.com",
          projectId: "feedback-app-ac30e",
          storageBucket: "feedback-app-ac30e.firebasestorage.app",
          messagingSenderId: "512179147778",
          appId: "1:512179147778:web:795e4a8b177fe766d3431b",
          measurementId: "G-X6MP0FFH9P"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRefuerzos = collection(db, "refuerzos_calidad"); // colecci√≥n de refuerzos
        const colAsesores = collection(db, "asesores");           // colecci√≥n de asesores

        /* ----------------- ESTADO ----------------- */
        let refuerzosCache = [];
        let filtroTexto = "";
        let filtroEstado = "todos";
        let asesoresMap = {}; // { id: { nombre, gc } }

        /* ----------------- UTILIDADES UI ----------------- */
        function setLoading(show, text = "Procesando‚Ä¶") {
            const overlay = document.getElementById("loadingOverlay");
            const label = document.getElementById("loadingText");
            label.textContent = text;
            overlay.style.display = show ? "flex" : "none";
        }

        function setToday() {
            const inputFecha = document.getElementById("fecha");
            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, "0");
            const dd = String(hoy.getDate()).padStart(2, "0");
            inputFecha.value = `${yyyy}-${mm}-${dd}`;
        }

        /* ----------------- CARGAR ASESORES ----------------- */
        async function cargarAsesores() {
            const cont = document.getElementById("asesoresLista");
        
            try {
                setLoading(true, "Cargando asesores‚Ä¶");
        
                const snap = await getDocs(colAsesores);
                const lista = snap.docs.map(d => ({
                    id: d.id,
                    ...d.data()
                }));
        
                lista.sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""));
        
                asesoresMap = {};
                cont.innerHTML = "";
        
                if (!lista.length) {
                    cont.innerHTML = "<div>No hay asesores registrados</div>";
                    return;
                }
        
                lista.forEach(a => {
                    const id = a.id;
                    const nombre = a.nombre || "(sin nombre)";
                    const gc = a.GC || a.gc || "";
        
                    asesoresMap[id] = { nombre, gc };
        
                    cont.innerHTML += `
                        <label class="checkbox-item">
                            <input type="checkbox" value="${id}">
                            <span>${nombre} ${gc ? "‚Äî " + gc : ""}</span>
                        </label>
                    `;
                });
        
            } catch (e) {
                console.error(e);
                cont.innerHTML = "<div>Error cargando asesores</div>";
                alert("Error cargando asesores: " + e.message);
            } finally {
                setLoading(false);
            }
        }
        /* ----------------- CARGAR REFUERZOS ----------------- */
        async function cargarRefuerzos() {
            setLoading(true, "Cargando refuerzos‚Ä¶");
            try {
                const snap = await getDocs(colRefuerzos);
                refuerzosCache = snap.docs.map(d => ({
                    id: d.id,
                    ...d.data()
                }));
                // ordenar por fechaRefuerzo (desc)
                refuerzosCache.sort((a, b) => {
                    const fa = a.fechaRefuerzo ? new Date(a.fechaRefuerzo) : 0;
                    const fb = b.fechaRefuerzo ? new Date(b.fechaRefuerzo) : 0;
                    return fb - fa;
                });
                renderTabla();
            } catch (e) {
                console.error(e);
                alert("Error cargando refuerzos: " + e.message);
            } finally {
                setLoading(false);
            }
        }

        function esIncompleto(r) {
            return !r.fechaRefuerzo || !r.tipo || !r.tema || !r.publico || !r.objetivo;
        }

        function filtrarLista() {
            const q = (filtroTexto || "").trim().toLowerCase();
            let lista = [...refuerzosCache];

            if (q) {
                lista = lista.filter(r => {
                    const join = [
                        r.tema || "",
                        r.tipo || "",
                        r.publico || "",
                        r.detalle || "",
                        r.objetivo || "",
                        r.responsable || "",
                        r.agenteNombre || ""
                    ].join(" ").toLowerCase();
                    return join.includes(q);
                });
            }

            if (filtroEstado !== "todos") {
                lista = lista.filter(r => {
                    const incompleto = esIncompleto(r);
                    const firmado = !!r.firmado;
                    if (filtroEstado === "incompleto") return incompleto;
                    if (filtroEstado === "firmado") return firmado && !incompleto;
                    if (filtroEstado === "pendiente") return !firmado && !incompleto;
                    return true;
                });
            }
            return lista;
        }

        function actualizarMetricas() {
            const total = refuerzosCache.length;
            const firmados = refuerzosCache.filter(r => r.firmado && !esIncompleto(r)).length;
            const pendientes = refuerzosCache.filter(r => !r.firmado && !esIncompleto(r)).length;
            document.getElementById("metricTotal").textContent = total;
            document.getElementById("metricFirmados").textContent = firmados;
            document.getElementById("metricPendientes").textContent = pendientes;
        }

        function renderTabla() {
            const tbody = document.getElementById("tablaRefuerzos");
            const lista = filtrarLista();
            actualizarMetricas();

            if (!lista.length) {
                tbody.innerHTML = "<tr><td colspan='6'>Sin refuerzos registrados con los criterios actuales.</td></tr>";
                return;
            }

            tbody.innerHTML = lista.map(r => {
                const fechaStr = r.fechaRefuerzo
                    ? new Date(r.fechaRefuerzo).toLocaleDateString("es-PE")
                    : "-";
                const incompleto = esIncompleto(r);
                const firmado = !!r.firmado;

                let estadoClase = "estado-pend";
                let estadoTexto = "Pendiente de firma";

                if (incompleto) {
                    estadoClase = "estado-incomp";
                    estadoTexto = "Datos incompletos";
                } else if (firmado) {
                    estadoClase = "estado-ok";
                    estadoTexto = "Firmado por agente";
                }

                const firmaNombre = r.firmaNombre || "‚Äî";
                const firmaFecha = r.firmaFecha
                    ? new Date(r.firmaFecha).toLocaleString("es-PE")
                    : "Pendiente";

                return `
        <tr>
            <td>${fechaStr}</td>
            <td>
                <div style="font-weight:500">${r.tema || ""}</div>
                <div style="font-size:11px;color:var(--muted);">${r.tipo || ""}</div>
            </td>
            <td>${r.publico || ""}</td>
            <td style="font-size:11px;">
                <div><b>${firmaNombre}</b></div>
                <div style="color:var(--muted);">${firmaFecha}</div>
            </td>
            <td>
                <span class="estado-pill ${estadoClase}">
                    ${estadoTexto}
                </span>
            </td>
            <td>
                <div class="actions">
                    <button class="btn-xs primary" onclick="verPdf('${r.id}')">üìÑ Ver PDF</button>
                    <button class="btn-xs success" onclick="copiarLinkFirma('${r.id}')">‚úçÔ∏è Link firma</button>
                </div>
            </td>
        </tr>`;
            }).join("");
        }

        /* ----------------- GUARDAR ----------------- */
        async function guardarRefuerzo() {
            const fechaInput = document.getElementById("fecha").value;
            const tipo = document.getElementById("tipo").value;
            const tema = document.getElementById("tema").value.trim();
            const canal = document.getElementById("canal").value;
            const responsable = document.getElementById("responsable").value;
            const objetivo = document.getElementById("objetivo").value.trim();
            const detalle = document.getElementById("detalle").value.trim();

            // asesores seleccionados
            const checks = Array.from(document.querySelectorAll("#asesoresLista input[type='checkbox']:checked"))
                    .map(ch => ch.value);
            const asesoresSeleccionados = checks
                .map(id => {
                    const info = asesoresMap[id];
                    if (!info) return null;
                    return {
                        asesorId: id,
                        nombre: info.nombre,
                        gc: info.gc || ""
                    };
                })
                .filter(x => x);
            
            const publico = asesoresSeleccionados.map(a => a.nombre).join(", ");

            if (!fechaInput || !tipo || !tema || !objetivo) {
                alert("Completa al menos: Fecha, Tipo, Tema y Objetivo.");
                return;
            }

            const fechaRefuerzo = new Date(fechaInput + "T00:00:00");

            const data = {
                fechaRefuerzo: fechaRefuerzo.toISOString(),
                tipo,
                tema,
                canal,
                publico,               // cadena visible
                asesores: asesoresSeleccionados, // array de objetos
                responsable,
                objetivo,
                detalle,
                // Campos para firma (portal_agente.html deber√° actualizar estos)
                firmado: false,
                firmaNombre: "",
                firmaFecha: null,
                agenteNombre: "", // opcional: puede llenarse luego
                createdAt: serverTimestamp()
            };

            try {
                setLoading(true, "Guardando refuerzo‚Ä¶");
                await addDoc(colRefuerzos, data);
                alert("Refuerzo registrado correctamente.");
                limpiarFormulario();
                await cargarRefuerzos();
            } catch (e) {
                console.error(e);
                alert("Error al guardar: " + e.message);
            } finally {
                setLoading(false);
            }
        }

        function limpiarFormulario() {
            setToday();
            document.getElementById("tipo").value = "";
            document.getElementById("tema").value = "";
            document.getElementById("canal").value = "";
            document.getElementById("objetivo").value = "";
            document.getElementById("detalle").value = "";
            const select = document.getElementById("asesoresSelect");
            if (select) {
                Array.from(select.options).forEach(o => (o.selected = false));
            }
        }

        /* ----------------- ACCIONES POR REGISTRO ----------------- */
        window.verPdf = function(id) {
            // Se asume que visualizacion_feedback.html usa ?id= para renderizar el PDF
            const url = `visualizacion_feedback.html?id=${id}`;
            window.open(url, "_blank");
        };

        window.copiarLinkFirma = async function(id) {
            try {
                const base = window.location.origin === "null"
                    ? ""
                    : window.location.origin;
                const url = base
                    ? `${base}/portal_agente.html?id=${id}`
                    : `portal_agente.html?id=${id}`;
                await navigator.clipboard.writeText(url);
                alert("Link de firma copiado al portapapeles:\n" + url);
            } catch (e) {
                console.error(e);
                alert("No se pudo copiar el link. URL:\nportal_agente.html?id=" + id);
            }
        };

        /* ----------------- FILTROS / BUSCADOR ----------------- */
        document.getElementById("searchTabla").addEventListener("input", e => {
            filtroTexto = e.target.value || "";
            renderTabla();
        });

        document.getElementById("filtroEstado").addEventListener("change", e => {
            filtroEstado = e.target.value;
            renderTabla();
        });

        /* ----------------- NAVEGACI√ìN SUPERIOR ----------------- */
        document.getElementById("btnIrBuscador").onclick = () => {
            window.location.href = "index.html"; // ajusta si tu buscador tiene otro nombre
        };
        document.getElementById("btnIrAdmin").onclick = () => {
            window.location.href = "admin.html";
        };

        /* ----------------- MODO OSCURO ----------------- */
        const themeBtn = document.getElementById("themeToggle");
        function applyTheme(theme) {
            if (theme === "dark") {
                document.body.classList.add("dark");
                themeBtn.textContent = "‚òÄÔ∏è Modo claro";
            } else {
                document.body.classList.remove("dark");
                themeBtn.textContent = "üåô Modo oscuro";
            }
        }
        const savedTheme = localStorage.getItem("fe_refuerzos_theme") || "light";
        applyTheme(savedTheme);
        themeBtn.onclick = () => {
            const next = document.body.classList.contains("dark") ? "light" : "dark";
            localStorage.setItem("fe_refuerzos_theme", next);
            applyTheme(next);
        };

        /* ----------------- INICIAL ----------------- */
        setToday();
        await cargarAsesores();
        await cargarRefuerzos();
    </script>
</body>
</html>
