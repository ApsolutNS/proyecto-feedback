<script>
const API_POST = "/.netlify/functions/register";

// Cargar asesores
async function cargarAsesores() {
  try {
    const res = await fetch("/data/asesores.json", { cache: "no-store" });
    const lista = await res.json();
    document.getElementById("asesor").innerHTML =
      lista.map(a => `<option>${a}</option>`).join("");
  } catch (err) {
    console.error("Error cargando asesores:", err);
  }
}
cargarAsesores();


// Detectar tipo
function detectarTipoTexto(text){
  if(!text) return 'NO IDENTIFICADO';
  text = text.toLowerCase();
  if(text.includes('intefectivank') || text.includes('vank')) return 'EFECTIVANK';
  if(text.includes('intefectiva')) return 'EFECTIVA';
  if(text.includes('intxperto')) return 'XPERTO';
  if(text.includes('facebook')) return 'FACEBOOK';
  if(text.includes('instagram')) return 'INSTAGRAM';
  if(text.includes('correo') || text.includes('mail')) return 'CORREO';
  return 'OTRO';
}

document.getElementById('idLlamada').addEventListener('input', updateDetected);
document.getElementById('idContacto').addEventListener('input', updateDetected);

function updateDetected(){
  const v = idLlamada.value + " " + idContacto.value;
  tipoDetectado.value = detectarTipoTexto(v);
}


// Items
const ITEMS = [
  ["Corte de Gestión",5],["Insulto / Falta de Respeto",10],["Normativa Regulatoria",8],
  ["Protección de datos",10],["Contestación sin demora",6],["Optimización de esperas",4],
  ["Empatía e implicación",4],["Escucha Activa",4],["Sondeo",3],
  ["Solicita datos de forma correcta y oportuna",3],["Herramientas de Gestión",3],
  ["Codificación y Registro inConcert",2],["Codificación y Registro en Monitor Logístico",2],
  ["Codificación y Registro en SmartSheet",2],["Presentación",2],["Personalización",2],
  ["Despedida",2],["Encuesta de satisfacción",2],["Lenguaje",2],["Voz",2],
  ["Redacta de forma Correcta",2],["Imagen trasladada",2],["Actitud comercial",3],
  ["Operativa",3],["Tramita la gestión correspondiente",5],["Transferencia",4],
  ["Cumple con devolución de llamado",4],["Actitud - Manejo de llamada",3],
  ["Conocimientos para resolver la consulta",5],["Asesoramiento de Producto o Servicio",4],
  ["Solución al primer contacto",12],["Verificación de datos",3],
  ["Damos el número de Ticket",1],["Ninguno",0]
];

function addItemBlock(){
  const block = document.createElement("div");
  block.className = "item-block";

  block.innerHTML = `
    <select>
      ${ITEMS.map(it => `<option value="${it[0]}||${it[1]}">${it[0]} (${it[1]}%)</option>`).join("")}
    </select>
    <textarea placeholder="Detalle del item"></textarea>
    <button class="btn ghost" onclick="this.parentNode.remove()">Eliminar</button>
  `;

  document.getElementById("itemsContainer").appendChild(block);
}

function clearItems(){
  document.getElementById("itemsContainer").innerHTML = "";
}


// Vista previa de imágenes
document.getElementById('imgs').addEventListener('change', function(){
  const preview = document.getElementById('imgPreview');
  preview.innerHTML = "";
  
  Array.from(this.files).forEach(file=>{
    const reader = new FileReader();
    reader.onload = e =>{
      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "img-preview";
      preview.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});


// Enviar registro
async function submitRecord(){
  const msg = document.getElementById('msg');
  msg.style.color = "green";
  msg.textContent = "⏳ Enviando...";

  try {
    // Items
    const items = Array.from(document.querySelectorAll(".item-block")).map(b=>{
      const [name, perc] = b.querySelector("select").value.split("||");
      return {
        name,
        perc: parseFloat(perc),
        detail: b.querySelector("textarea").value
      };
    });

    // Images
    const files = document.getElementById("imgs").files;
    const images = await Promise.all([...files].map(f=>{
      return new Promise(res=>{
        const fr = new FileReader();
        fr.onload = e => res({ name: f.name, data: e.target.result });
        fr.readAsDataURL(f);
      });
    }));

    // Datos completos
    const body = {
      idLlamada: idLlamada.value,
      idContacto: idContacto.value,
      tipo: tipoDetectado.value,
      asesor: asesor.value,
      cargo: cargo.value,

      clienteDni: cliDni.value,
      clienteNombre: cliNombre.value,
      clienteTel: cliTel.value,

      tipificacion: cliTipif.value,
      observacionCliente: cliObs.value,
      resumen: resumen.value,

      items,
      images,

      nota: 0,            // por defecto
      compromiso: "",     // por defecto
      firmaUrl: "",       // campo vacío para Google Sheets
      fechaHora: new Date().toLocaleString("es-PE")
    };

    const res = await fetch(API_POST, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const out = await res.json();

    if(out.ok){
      msg.style.color = "green";
      msg.textContent = "✔ Registro enviado correctamente";

      clearItems();
      document.getElementById("imgPreview").innerHTML = "";
    } else {
      msg.style.color = "red";
      msg.textContent = "❌ Error: " + out.message;
    }

  } catch(err){
    msg.style.color = "red";
    msg.textContent = "❌ Error inesperado: " + err.message;
    console.error(err);
  }
}
</script>
