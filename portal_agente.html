<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal del Agente — Dark Mode</title>

<style>
  /* -------------------- DARK THEME -------------------- */
  body{
    font-family:Arial,Helvetica,sans-serif;
    background:#0f172a;
    margin:0;
    padding:18px;
    color:#e2e8f0;
  }
  .card{
    max-width:980px;
    margin:auto;
    background:#1e293b;
    padding:18px;
    border-radius:10px;
    border:1px solid #334155;
    box-shadow:0 0 25px rgba(0,0,0,0.35);
  }
  h2{margin-top:0;color:#fff;font-weight:700}

  label{display:block;margin-top:10px;font-weight:600;color:#cbd5e1}

  input,select,textarea{
    width:100%;
    padding:8px;
    border-radius:6px;
    border:1px solid #475569;
    margin-top:6px;
    background:#0f172a;
    color:#e2e8f0;
  }

  /* TABLE */
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    font-size:13px;
  }
  th{
    background:#334155;
    padding:8px;
    color:#e2e8f0;
    border-bottom:1px solid #475569;
  }
  td{
    padding:8px;
    border-bottom:1px solid #334155;
    color:#cbd5e1;
  }

  /* BUTTONS */
  .btn{
    background:#3b82f6;
    color:#fff;
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
    margin-top:10px;
    font-size:13px;
    transition:0.2s;
  }
  .btn:hover{background:#2563eb}
  .btn.ghost{
    background:transparent;
    border:1px solid #64748b;
    color:#93c5fd;
  }
  .btn.sm{padding:6px 10px;font-size:12px}

  .letter-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    margin-bottom:8px
  }
  .letter-title{
    font-size:18px;
    font-weight:bold;
    text-align:center;
    width:100%;
    color:#fff;
  }
  .letter-body{
    font-size:13px;
    line-height:1.4;
    color:#cbd5e1;
  }
  .section-title{
    font-weight:bold;margin-top:10px;color:#fff;
  }

  .signature-preview img{
    max-width:260px;
    border:1px solid #475569;
    border-radius:6px;
    margin-top:6px;
  }
  .signature-preview-empty{
    height:80px;border:1px dashed #475569;border-radius:6px;
    display:flex;align-items:center;justify-content:center;
    color:#64748b;font-size:12px;margin-top:6px
  }

  /* Modal */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,0.6);
    display:none;align-items:center;justify-content:center;z-index:999;
  }
  .modal-box{
    background:#1e293b;border-radius:10px;padding:16px;max-width:760px;width:95%;
    border:1px solid #334155;
  }
  #sigCanvas{
    border:1px solid #475569;border-radius:6px;display:block;margin:8px auto;background:#fff;
  }

  /* Badge pendings */
  .badgePending{
    display:inline-block;
    background:#ef4444;
    padding:4px 10px;
    border-radius:20px;
    font-size:12px;
    font-weight:bold;
    color:white;
  }
</style>
</head>

<body>

<div class="card">
  <h2>
    Portal del Agente
    <span id="pendingBadge" style="float:right"></span>
  </h2>

  <label>Seleccionar Asesor</label>
  <select id="selAgent" onchange="loadAgentList()">
    <option value="">-- selecciona --</option>
  </select>

  <div style="margin-top:12px">
    <strong style="color:#fff">Feedbacks del agente</strong>

    <table id="agentTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Nota</th>
          <th>Estado</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="detailBlock" style="display:none;margin-top:12px">
    <h3 style="color:white">Detalle del Feedback</h3>

    <div id="feedbackInfo" style="border:1px solid #334155;border-radius:6px;padding:16px;background:#0f172a"></div>

    <!-- COMPROMISO + FIRMA (solo si está pendiente) -->
    <div id="editableZone">
      <label style="margin-top:12px">Compromiso del agente</label>
      <textarea id="compromiso" rows="4"></textarea>

      <label style="margin-top:12px">Firma del agente</label>

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn sm" onclick="openDrawModal()">Dibujar firma</button>
        <button class="btn ghost sm" onclick="triggerUpload()">Subir firma</button>
        <input type="file" id="fileSignature" accept="image/*" style="display:none">
      </div>

      <div id="signaturePreview" class="signature-preview-empty">Sin firma seleccionada</div>

      <button class="btn" onclick="saveSignature()">Enviar firma y completar</button>
    </div>

    <div id="agentMsg" style="margin-top:10px;font-size:13px"></div>
  </div>
</div>

<!-- MODAL PARA DIBUJAR FIRMA -->
<div id="signatureModal" class="modal-backdrop">
  <div class="modal-box">
    <h3 style="color:white">Dibujar firma del agente</h3>
    <canvas id="sigCanvas" width="700" height="160"></canvas>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
      <button class="btn ghost sm" onclick="clearCanvas()">Limpiar</button>
      <button class="btn ghost sm" onclick="closeDrawModal()">Cancelar</button>
      <button class="btn sm" onclick="saveDrawnSignature()">Usar esta firma</button>
    </div>
  </div>
</div>


<script type="module">
/* FIREBASE IMPORTS */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, where,
  doc, getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import {
  getStorage, ref, uploadString, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyD4cFHDbSfJNAhTuuP01N5JZQd-FOYB2LM",
  authDomain: "feedback-app-ac30e.firebaseapp.com",
  projectId: "feedback-app-ac30e",
  storageBucket: "feedback-app-ac30e.firebasestorage.app",
  messagingSenderId: "512179147778",
  appId: "1:512179147778:web:795e4a8b177fe766d3431b"
};
initializeApp(firebaseConfig);
const db = getFirestore();
const storage = getStorage();

/* LOAD ADVISORS */
let asesores = {};
async function loadAdvisors(){
  const snap = await getDocs(collection(db,"asesores"));
  snap.forEach(d=>{
    const a = d.data();
    if(a.nombre) asesores[a.nombre] = a.GC || "SIN GC";
  });

  const sel = document.getElementById("selAgent");
  sel.innerHTML = "<option value=''>-- selecciona --</option>";
  Object.keys(asesores).sort().forEach(n=>{
    sel.innerHTML += `<option value="${n}">${n} — ${asesores[n]}</option>`;
  });
}
loadAdvisors();

/* COUNT PENDING */
function updatePendingBadge(list){
  const p = list.filter(x=>x.estado==="PENDIENTE").length;
  const badge = document.getElementById("pendingBadge");
  if(p===0){
    badge.innerHTML = "";
  } else {
    badge.innerHTML = `<span class="badgePending">${p} pendientes</span>`;
  }
}

/* LIST FEEDBACKS */
window.loadAgentList = async function(){
  const advisor = selAgent.value;
  const tbody = document.querySelector("#agentTable tbody");
  if(!advisor){
    tbody.innerHTML = "<tr><td colspan='5'>Selecciona un asesor</td></tr>";
    updatePendingBadge([]);
    return;
  }

  const qRef = query(collection(db,"registros"), where("asesor","==",advisor));
  const snap = await getDocs(qRef);

  const list = [];
  snap.forEach(d=>{
    const r = d.data();
    list.push({
      id: d.id,
      fecha: new Date(r.fecha),
      nota: r.nota ?? 0,
      estado: r.estado || "PENDIENTE"
    });
  });

  list.sort((a,b)=>b.fecha - a.fecha);
  updatePendingBadge(list);

  tbody.innerHTML = list.map(r=>`
    <tr>
      <td>${r.id}</td>
      <td>${r.fecha.toLocaleString("es-PE")}</td>
      <td>${r.nota}%</td>
      <td>${r.estado}</td>
      <td><button class="btn sm" onclick="openDetail('${r.id}')">Abrir</button></td>
    </tr>
  `).join("");
};

/* OPEN DETAIL */
let currentID = null;
let signatureData = null;

window.openDetail = async function(id){
  currentID = id;

  const snap = await getDoc(doc(db,"registros",id));
  if(!snap.exists()) return alert("No existe este registro");
  const r = snap.data();

  document.getElementById("detailBlock").style.display = "block";

  const itemsHtml = (r.items||[]).map(it=>`
    <div style="margin-bottom:4px">
      <strong>${it.name}</strong> (${it.perc}%)
      <div style="margin-left:8px">${it.detail || ""}</div>
    </div>
  `).join("");

  const imgsHtml = (r.imagenes||[]).map(im=>`
    <img src="${im.url}" style="width:100%;max-width:680px;margin-top:8px;border-radius:6px">
  `).join("");

  document.getElementById("feedbackInfo").innerHTML = `
    <div class="letter-header">
      <div class="letter-title">RETROALIMENTACIÓN</div>
      <img src="https://firebasestorage.googleapis.com/v0/b/feedback-app-ac30e.firebasestorage.app/o/firmas%2FImagen1.png?alt=media&token=730b1e7c-abbf-4369-9e8c-fafad2b39883"
           style="max-height:42px">
    </div>

    <div class="letter-body">
      <p>
        Retroalimentación realizada a <strong>${r.asesor}</strong> (GC: ${r.gc || ""}).
      </p>

      <div class="section-title">Cliente</div>
      DNI: ${r.cliente?.dni || ""}<br>
      Nombre: ${r.cliente?.nombre || ""}<br>
      Tel: ${r.cliente?.tel || ""}<br>

      <div class="section-title">Items observados</div>
      ${itemsHtml}

      <div class="section-title">Nota</div>
      <div style="font-size:22px;font-weight:bold">${r.nota}%</div>

      <div class="section-title">Evidencias</div>
      ${imgsHtml}
    </div>
  `;

  /* If COMPLETED → disable edition */
  if(r.estado === "COMPLETADO"){
    document.getElementById("editableZone").style.display = "none";
  } else {
    document.getElementById("editableZone").style.display = "block";
    document.getElementById("compromiso").value = r.compromiso || "";
    signatureData = r.firmaUrl || null;
    updateSignaturePreview();
  }
};

/* SIGNATURE */
function updateSignaturePreview(){
  const box = document.getElementById("signaturePreview");
  if(signatureData){
    box.className = "signature-preview";
    box.innerHTML = `<img src="${signatureData}">`;
  } else {
    box.className = "signature-preview-empty";
    box.innerHTML = "Sin firma seleccionada";
  }
}

/* SAVE SIGNATURE */
window.saveSignature = async function(){
  const compromiso = compromiso.value.trim();
  if(!compromiso) return alert("Debe escribir el compromiso");
  if(!signatureData) return alert("Debe adjuntar o dibujar una firma");

  const msg = document.getElementById("agentMsg");
  msg.style.color = "#4ade80";
  msg.textContent = "Guardando...";

  try{
    const sigRef = ref(storage, `firmas/${currentID}.png`);
    await uploadString(sigRef, signatureData, "data_url");
    const url = await getDownloadURL(sigRef);

    await updateDoc(doc(db,"registros",currentID),{
      compromiso,
      firmaUrl:url,
      estado:"COMPLETADO"
    });

    msg.textContent = "Completado correctamente ✓";
    loadAgentList();
    document.getElementById("editableZone").style.display = "none";

  }catch(e){
    msg.style.color = "red";
    msg.textContent = "Error: "+e.message;
  }
};


/* DRAW SIGNATURE */
const modal = document.getElementById("signatureModal");
const canvas = document.getElementById("sigCanvas");
const ctx = canvas.getContext("2d");
let drawing = false;

function pos(e){
  const r = canvas.getBoundingClientRect();
  const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
  const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
  return {x,y};
}

canvas.addEventListener("mousedown", e=>{drawing=true;ctx.moveTo(pos(e).x,pos(e).y);});
canvas.addEventListener("mouseup", ()=>drawing=false);
canvas.addEventListener("mousemove", e=>{
  if(!drawing) return;
  const p = pos(e);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";
  ctx.lineTo(p.x,p.y);
  ctx.stroke();
});

canvas.addEventListener("touchstart", e=>{drawing=true;ctx.moveTo(pos(e).x,pos(e).y);});
canvas.addEventListener("touchend", ()=>drawing=false);
canvas.addEventListener("touchmove", e=>{
  if(!drawing) return;
  e.preventDefault();
  const p = pos(e);
  ctx.lineTo(p.x,p.y);
  ctx.stroke();
});

window.openDrawModal = ()=>{ctx.clearRect(0,0,canvas.width,canvas.height);modal.style.display="flex";};
window.closeDrawModal = ()=> modal.style.display="none";

window.saveDrawnSignature = ()=>{
  signatureData = canvas.toDataURL("image/png");
  updateSignaturePreview();
  modal.style.display="none";
};

window.clearCanvas = ()=> ctx.clearRect(0,0,canvas.width,canvas.height);

window.triggerUpload = ()=> fileSignature.click();
fileSignature.addEventListener("change", e=>{
  const f = e.target.files[0];
  const reader = new FileReader();
  reader.onload = ev=>{
    signatureData = ev.target.result;
    updateSignaturePreview();
  };
  reader.readAsDataURL(f);
});

</script>

</body>
</html>
