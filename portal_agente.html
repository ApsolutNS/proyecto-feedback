<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal del Agente</title>
<style>
  body{font-family:Arial;background:#f4f6fb;margin:0;padding:18px}
  .card{max-width:980px;margin:auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(10,20,30,0.06)}
  h2{margin-top:0}
  label{display:block;margin-top:10px;font-weight:600}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px;box-sizing:border-box}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
  th{background:#fbfdff}
  canvas{border:1px solid #e6eef9;border-radius:6px; margin-top:10px}
  .btn{background:#0f4c81;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;margin-top:10px}
  .btn.ghost{background:#fff;color:#0f4c81;border:1px solid #cbd5e1}
</style>
</head>
<body>

<div class="card">
  <h2>Portal del Agente</h2>

  <label>Seleccionar Asesor</label>
  <select id="selAgent" onchange="loadAgentList()">
    <option value="">-- selecciona --</option>
  </select>

  <div style="margin-top:12px">
    <strong>Feedbacks del agente</strong>
    <table id="agentTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Nota</th>
          <th>Estado</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="detailBlock" style="display:none;margin-top:12px">
    <h3>Completar Feedback</h3>
    <div id="feedbackInfo"></div>

    <label>Compromiso del agente</label>
    <textarea id="compromiso" rows="4"></textarea>

    <label>Firma (dibujar)</label>
    <canvas id="canvas" width="700" height="140"></canvas>

    <div style="display:flex;gap:8px">
      <button class="btn" onclick="saveSignature()">Enviar Firma y Completar</button>
      <button class="btn ghost" onclick="clearCanvas()">Limpiar Firma</button>
    </div>

    <div id="agentMsg" style="margin-top:10px;color:green"></div>
  </div>
</div>

<script type="module">

/* ------------------- IMPORTS FIREBASE -------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, where,
  doc, getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

import {
  getStorage, ref, uploadString, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

/* ------------------- CONFIG ------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD4cFHDbSfJNAhTuuP01N5JZQd-FOYB2LM",
  authDomain: "feedback-app-ac30e.firebaseapp.com",
  projectId: "feedback-app-ac30e",
  storageBucket: "feedback-app-ac30e.firebasestorage.app",
  messagingSenderId: "512179147778",
  appId: "1:512179147778:web:795e4a8b177fe766d3431b",
  measurementId: "G-X6MP0FFH9P"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ------------------- PARSE FECHA ------------------------- */
function parseFecha(rec){
  if(rec.fechaHora){
    if(rec.fechaHora.toDate) return rec.fechaHora.toDate();
    return new Date(rec.fechaHora);
  }
  if(rec.fecha){
    if(rec.fecha.toDate) return rec.fecha.toDate();
    return new Date(rec.fecha);
  }
  return new Date();
}

/* ------------------- CARGAR ASESORES --------------------- */
async function loadAdvisors(){
  try{
    const snap = await getDocs(collection(db,"registros"));
    const set = new Set();
    snap.forEach(d=>{ if(d.data().asesor) set.add(d.data().asesor); });

    const sel = document.getElementById("selAgent");
    sel.innerHTML = '<option value="">-- selecciona --</option>';

    [...set].sort().forEach(n=>{
      sel.innerHTML += `<option>${n}</option>`;
    });

  }catch(err){ console.error("Error:",err); }
}
loadAdvisors();

/* ------------------- LISTA POR AGENTE -------------------- */
window.loadAgentList = async function(){
  const advisor = document.getElementById("selAgent").value;
  const tbody = document.querySelector("#agentTable tbody");

  if(!advisor){
    tbody.innerHTML = '<tr><td colspan="5">Selecciona un asesor</td></tr>';
    return;
  }

  try{
    const qRef = query(collection(db,"registros"), where("asesor","==",advisor));
    const snap = await getDocs(qRef);

    const list=[];
    snap.forEach(d=>{
      const data=d.data();
      list.push({
        id:d.id,
        nota:data.nota ?? 0,
        estado:data.estado || "PENDIENTE",
        fecha:parseFecha(data)
      });
    });

    list.sort((a,b)=>b.fecha - a.fecha);

    tbody.innerHTML = list.map(r=>`
      <tr>
        <td>${r.id}</td>
        <td>${r.fecha.toLocaleString("es-PE")}</td>
        <td>${r.nota}%</td>
        <td>${r.estado}</td>
        <td><button onclick="openDetail('${r.id}')">Abrir</button></td>
      </tr>
    `).join("");

  }catch(err){
    console.error(err);
    tbody.innerHTML = '<tr><td colspan="5">Error cargando datos</td></tr>';
  }
};

/* ------------------- ABRIR DETALLE ------------------------ */
let currentRecordId = null;

window.openDetail = async function(id){
  try{
    const snap = await getDoc(doc(db,"registros",id));
    if(!snap.exists()) return alert("Registro no encontrado");

    const rec = snap.data();
    currentRecordId = id;

    const feedbackInfo = document.getElementById("feedbackInfo");
    const compromisoEl = document.getElementById("compromiso");
    const imagenes = rec.imagenes || [];

    const items = rec.items || [];
    const itemsText = items.map(it=>`${it.name} (${it.perc}%)`).join("; ");

    const evidenciasHtml = imagenes.map(im => `
      <img src="${im.url}" 
           style="width:100%; max-width:700px; border-radius:8px; margin-top:10px">
    `).join("");

    feedbackInfo.innerHTML = `
      <div><b>ID:</b> ${id}</div>
      <div><b>Fecha:</b> ${parseFecha(rec).toLocaleString("es-PE")}</div>
      <div><b>Asesor:</b> ${rec.asesor}</div>
      <div><b>Tipo:</b> ${rec.tipo}</div>
      <div style="margin-top:8px"><b>Resumen:</b> ${rec.resumen}</div>
      <div style="margin-top:8px"><b>Items:</b> ${itemsText}</div>

      <div style="margin-top:8px">
        <b>Evidencias:</b> ${imagenes.length} imagen(es)
        <div>${evidenciasHtml}</div>
      </div>
    `;

    compromisoEl.value = rec.compromiso || "";
    document.getElementById("detailBlock").style.display="block";

  }catch(err){
    console.error(err);
    alert("Error al abrir el detalle");
  }
};

/* ------------------- FIRMA ------------------------------- */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let drawing=false;

canvas.addEventListener("mousedown",()=>drawing=true);
canvas.addEventListener("mouseup",()=>{drawing=false;ctx.beginPath();});
canvas.addEventListener("mouseleave",()=>{drawing=false;ctx.beginPath();});
canvas.addEventListener("mousemove",e=>{
  if(!drawing) return;
  const r = canvas.getBoundingClientRect();
  ctx.lineWidth=2;
  ctx.lineCap="round";
  ctx.strokeStyle="#000";
  ctx.lineTo(e.clientX-r.left, e.clientY-r.top);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(e.clientX-r.left, e.clientY-r.top);
});

window.clearCanvas = function(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
};

/* ------------------- GUARDAR FIRMA ----------------------- */
window.saveSignature = async function(){
  if(!currentRecordId) return alert("Abra un registro");

  const compromiso = document.getElementById("compromiso").value.trim();
  if(!compromiso) return alert("El compromiso es obligatorio");

  const agentMsg = document.getElementById("agentMsg");

  try{
    agentMsg.textContent = "Subiendo firma...";
    const dataUrl = canvas.toDataURL("image/png");
    const sigRef = ref(storage, `firmas/${currentRecordId}.png`);

    await uploadString(sigRef, dataUrl, "data_url");
    const url = await getDownloadURL(sigRef);

    await updateDoc(doc(db,"registros",currentRecordId),{
      compromiso,
      firmaUrl:url,
      estado:"COMPLETADO"
    });

    agentMsg.textContent = "Guardado correctamente";
    loadAgentList();

  }catch(err){
    agentMsg.textContent = "Error: "+err.message;
    console.error(err);
  }
};

</script>

</body>
</html>
