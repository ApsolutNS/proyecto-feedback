<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal del Agente</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f6fb;margin:0;padding:18px}
  .card{max-width:980px;margin:auto;background:#fff;padding:18px;border-radius:8px;
        box-shadow:0 6px 18px rgba(10,20,30,0.06)}
  h2{margin-top:0}
  label{display:block;margin-top:10px;font-weight:600}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px;box-sizing:border-box}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
  th{background:#fbfdff}
  .btn{background:#0f4c81;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin-top:10px;font-size:13px}
  .btn.ghost{background:#fff;color:#0f4c81;border:1px solid #cbd5e1}
  .btn.sm{padding:6px 10px;font-size:12px}
  .letter-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
  .letter-title{font-size:18px;font-weight:bold;text-align:center;width:100%}
  .logo-box img{max-height:42px}
  .letter-body{font-size:13px;line-height:1.4}
  .section-title{font-weight:bold;margin-top:10px}
  .signature-preview img{max-width:260px;border:1px solid #e5e7eb;border-radius:6px;margin-top:6px}
  .signature-preview-empty{height:80px;border:1px dashed #e5e7eb;border-radius:6px;
                           display:flex;align-items:center;justify-content:center;
                           color:#94a3b8;font-size:12px;margin-top:6px}
  /* Modal firma */
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(15,23,42,0.45);
    display:none;align-items:center;justify-content:center;z-index:999;
  }
  .modal-box{
    background:#fff;border-radius:10px;padding:16px;max-width:760px;width:95%;
    box-shadow:0 20px 40px rgba(15,23,42,0.35);
  }
  .modal-box h3{margin-top:0;margin-bottom:8px}
  #sigCanvas{border:1px solid #e2e8f0;border-radius:6px;display:block;margin:8px auto}
</style>
</head>
<body>

<div class="card">
  <h2>Portal del Agente</h2>

  <label>Seleccionar Asesor</label>
  <select id="selAgent" onchange="loadAgentList()">
    <option value="">-- selecciona --</option>
  </select>

  <div style="margin-top:12px">
    <strong>Feedbacks del agente</strong>
    <table id="agentTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Nota</th>
          <th>Estado</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="detailBlock" style="display:none;margin-top:12px">
    <h3>Completar Feedback</h3>

    <!-- Carta de retroalimentación -->
    <div id="feedbackInfo"
         style="border:1px solid #e2e8f0;border-radius:6px;padding:16px;background:#fff"></div>

    <label style="margin-top:12px">Compromiso del agente</label>
    <textarea id="compromiso" rows="4"></textarea>

    <label style="margin-top:12px">Firma del agente</label>
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
      <button type="button" class="btn sm" onclick="openDrawModal()">Dibujar firma</button>
      <button type="button" class="btn ghost sm" onclick="triggerUpload()">Subir firma</button>
      <input type="file" id="fileSignature" accept="image/*" style="display:none">
    </div>
    <div id="signaturePreview" class="signature-preview-empty">
      Sin firma seleccionada
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" onclick="saveSignature()">Enviar firma y completar</button>
    </div>

    <div id="agentMsg" style="margin-top:10px;color:green;font-size:13px"></div>
  </div>
</div>

<!-- Modal para dibujar firma -->
<div id="signatureModal" class="modal-backdrop">
  <div class="modal-box">
    <h3>Dibujar firma del agente</h3>
    <p style="font-size:12px;color:#64748b;margin:0 0 6px">
      Usa el mouse (o dedo, si estás en pantalla táctil) para dibujar tu firma.
    </p>
    <canvas id="sigCanvas" width="700" height="160"></canvas>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
      <button class="btn ghost sm" onclick="clearCanvasInternal()">Limpiar</button>
      <button class="btn ghost sm" onclick="closeDrawModal()">Cancelar</button>
      <button class="btn sm" onclick="saveDrawnSignature()">Usar esta firma</button>
    </div>
  </div>
</div>

<script type="module">
/* -------------------------------------------------------------
   IMPORTS FIREBASE
-------------------------------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, where,
  doc, getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

import {
  getStorage, ref, uploadString, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

/* -------------------------------------------------------------
   CONFIG FIREBASE
-------------------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD4cFHDbSfJNAhTuuP01N5JZQd-FOYB2LM",
  authDomain: "feedback-app-ac30e.firebaseapp.com",
  projectId: "feedback-app-ac30e",
  storageBucket: "feedback-app-ac30e.firebasestorage.app",
  messagingSenderId: "512179147778",
  appId: "1:512179147778:web:795e4a8b177fe766d3431b",
  measurementId: "G-X6MP0FFH9P"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* -------------------------------------------------------------
   MAPA ASESORES -> GC
-------------------------------------------------------------- */
let asesoresByNombre = {}; // { "Nombre asesor": "GCxxxx" }

async function loadAdvisors(){
  const snapAsesores = await getDocs(collection(db,"asesores"));
  asesoresByNombre = {};
  snapAsesores.forEach(d=>{
    const data = d.data();
    if(data.nombre){
      asesoresByNombre[data.nombre] = data.GC || "";
    }
  });

  const snapReg = await getDocs(collection(db,"registros"));
  const nombresEnRegistros = new Set();
  snapReg.forEach(d=>{
    const r = d.data();
    if(r.asesor) nombresEnRegistros.add(r.asesor);
  });

  const sel = document.getElementById("selAgent");
  sel.innerHTML = '<option value="">-- selecciona --</option>';

  [...nombresEnRegistros].sort().forEach(nombre=>{
    const gc = asesoresByNombre[nombre] || "SIN GC";
    sel.innerHTML += `<option value="${nombre}">${nombre} — ${gc}</option>`;
  });
}
loadAdvisors();

function getGC(nombre){
  return asesoresByNombre[nombre] || "SIN GC";
}

/* -------------------------------------------------------------
   FECHAS
-------------------------------------------------------------- */
function parseFechaRec(r){
  if(r.fechaHora){
    if(r.fechaHora.toDate) return r.fechaHora.toDate();
    return new Date(r.fechaHora);
  }
  if(r.fecha){
    if(r.fecha.toDate) return r.fecha.toDate();
    return new Date(r.fecha);
  }
  return new Date();
}

function fechaLarga(fecha){
  const dias = ["domingo","lunes","martes","miércoles","jueves","viernes","sábado"];
  const meses = ["enero","febrero","marzo","abril","mayo","junio",
                 "julio","agosto","septiembre","octubre","noviembre","diciembre"];
  return `${dias[fecha.getDay()]}, ${fecha.getDate()} de ${meses[fecha.getMonth()]} de ${fecha.getFullYear()}`;
}

/* -------------------------------------------------------------
   LISTA DE FEEDBACKS POR AGENTE
-------------------------------------------------------------- */
window.loadAgentList = async function(){
  const advisor = document.getElementById("selAgent").value;
  const tbody = document.querySelector("#agentTable tbody");

  if(!advisor){
    tbody.innerHTML = '<tr><td colspan="5">Selecciona un asesor</td></tr>';
    return;
  }

  const qRef = query(collection(db,"registros"), where("asesor","==",advisor));
  const snap = await getDocs(qRef);

  const list = [];
  snap.forEach(d=>{
    const data = d.data();
    list.push({
      id: d.id,
      nota: data.nota ?? 0,
      estado: data.estado || "PENDIENTE",
      fecha: parseFechaRec(data)
    });
  });

  list.sort((a,b)=>b.fecha - a.fecha);

  tbody.innerHTML = list.map(r=>`
    <tr>
      <td>${r.id}</td>
      <td>${r.fecha.toLocaleString("es-PE")}</td>
      <td>${r.nota}%</td>
      <td>${r.estado}</td>
      <td><button class="btn sm" onclick="openDetail('${r.id}')">Abrir</button></td>
    </tr>
  `).join("") || '<tr><td colspan="5">Sin registros</td></tr>';
};

/* -------------------------------------------------------------
   DETALLE TIPO CARTA
-------------------------------------------------------------- */
let currentRecordId = null;
let currentSignatureDataUrl = null; // firma actual (dibujada o subida)

window.openDetail = async function(id){
  const snap = await getDoc(doc(db,"registros",id));
  if(!snap.exists()) return alert("Registro no encontrado");

  const rec = snap.data();
  currentRecordId = id;

  const fecha = parseFechaRec(rec);
  const fechaTexto = fechaLarga(fecha);
  const gc = getGC(rec.asesor);

  const cli = rec.cliente || {};
  const tipif = rec.tipificacion || "";
  const comentario = rec.observacionCliente || "";

  const items = rec.items || [];
  const nota = rec.nota ?? 0;

  const itemsHtml = items.length
    ? items.map(it=>`
        <div style="margin-bottom:4px">
          <strong>${it.name}</strong> (${it.perc}%)
          <div style="margin-left:8px">${it.detail || ""}</div>
        </div>
      `).join("")
    : "<em>Sin ítems observados</em>";

  const evidencias = rec.imagenes || [];
  const imgsHtml = evidencias.length
    ? evidencias.map(im=>`
        <img src="${im.url}" style="width:100%;max-width:680px;margin-top:8px;border-radius:6px">
      `).join("")
    : "<em>Sin evidencias adjuntas</em>";

  const feedbackInfo = document.getElementById("feedbackInfo");
  feedbackInfo.innerHTML = `
    <div class="letter-header">
      <div class="letter-title">RETROALIMENTACIÓN</div>
      <div class="logo-box">
        <img src="https://firebasestorage.googleapis.com/v0/b/feedback-app-ac30e.firebasestorage.app/o/firmas%2FImagen1.png?alt=media&token=730b1e7c-abbf-4369-9e8c-fafad2b39883" alt="Logo GESCOB">
      </div>
    </div>

    <div class="letter-body">
      <p style="margin-top:0;margin-bottom:10px">
        Por medio de la presente se deja constancia que el <strong>${fechaTexto}</strong>
        se realiza una <strong>RETROALIMENTACIÓN</strong> al/la colaborador(a)
        <strong>${rec.asesor}</strong> con código <strong>${gc}</strong> quien ejerce la
        función de <strong>${rec.cargo || ""}</strong>, para el cumplimiento de los
        parámetros de la llamada.
      </p>

      <div class="section-title">Cliente</div>
      <div style="margin-left:8px;margin-bottom:6px">
        <div><strong>DNI:</strong> ${cli.dni || ""}</div>
        <div><strong>Nombre:</strong> ${cli.nombre || ""}</div>
        <div><strong>Número:</strong> ${cli.tel || ""}</div>
        <div><strong>Tipificación:</strong> ${tipif}</div>
        <div><strong>Comentario:</strong> ${comentario}</div>
      </div>

      <div class="section-title">Gestión monitoreada</div>
      <div style="margin-left:8px;margin-bottom:6px">
        <div><strong>ID Llamada:</strong> ${rec.idLlamada || ""}</div>
        <div><strong>ID Contacto:</strong> ${rec.idContacto || ""}</div>
        <div><strong>Tipo:</strong> ${rec.tipo || ""}</div>
        <div style="margin-top:6px">
          <strong>Resumen:</strong>
          <div style="padding:6px 8px;background:#f8fafc;border-radius:4px;margin-top:2px">
            ${rec.resumen || ""}
          </div>
        </div>
      </div>

      <div class="section-title">Items observados</div>
      <div style="margin-left:8px;margin-bottom:6px">
        ${itemsHtml}
      </div>

      <div class="section-title">Nota obtenida</div>
      <div style="margin-left:8px;margin-bottom:6px">
        <div style="display:inline-block;padding:6px 10px;border-radius:999px;
                    border:1px solid #fecaca;background:#fef2f2;color:#b91c1c;
                    font-weight:bold;">
          ${nota}%
        </div>
      </div>

      <div class="section-title">Evidencias</div>
      <div style="margin-left:8px;margin-bottom:6px">
        ${imgsHtml}
      </div>

      <div style="margin-top:10px;font-size:11px;color:#94a3b8">
        ID de registro: ${id}
      </div>
    </div>
  `;

  document.getElementById("compromiso").value = rec.compromiso || "";

  // preparar firma actual
  if(rec.firmaUrl){
    currentSignatureDataUrl = rec.firmaUrl;
  } else {
    currentSignatureDataUrl = null;
  }
  updateSignaturePreview();

  document.getElementById("agentMsg").textContent = "";
  document.getElementById("detailBlock").style.display = "block";
}

/* -------------------------------------------------------------
   FIRMA: MODAL DIBUJAR + SUBIR IMAGEN
-------------------------------------------------------------- */
const modal = document.getElementById("signatureModal");
const sigCanvas = document.getElementById("sigCanvas");
const ctx = sigCanvas.getContext("2d");
let drawing = false;

function pointerPos(evt){
  const rect = sigCanvas.getBoundingClientRect();
  const x = (evt.touches ? evt.touches[0].clientX : evt.clientX) - rect.left;
  const y = (evt.touches ? evt.touches[0].clientY : evt.clientY) - rect.top;
  return {x,y};
}

function startDraw(e){ drawing = true; const {x,y}=pointerPos(e); ctx.beginPath(); ctx.moveTo(x,y); }
function endDraw(){ drawing = false; }
function moveDraw(e){
  if(!drawing) return;
  e.preventDefault();
  const {x,y} = pointerPos(e);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";
  ctx.lineTo(x,y);
  ctx.stroke();
}

sigCanvas.addEventListener("mousedown", startDraw);
sigCanvas.addEventListener("mouseup", endDraw);
sigCanvas.addEventListener("mouseleave", endDraw);
sigCanvas.addEventListener("mousemove", moveDraw);

sigCanvas.addEventListener("touchstart", startDraw, {passive:false});
sigCanvas.addEventListener("touchend", endDraw, {passive:false});
sigCanvas.addEventListener("touchcancel", endDraw, {passive:false});
sigCanvas.addEventListener("touchmove", moveDraw, {passive:false});

function clearCanvasInternal(){
  ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
}
window.clearCanvasInternal = clearCanvasInternal;

window.openDrawModal = function(){
  clearCanvasInternal();
  modal.style.display = "flex";
};

window.closeDrawModal = function(){
  modal.style.display = "none";
};

window.saveDrawnSignature = function(){
  currentSignatureDataUrl = sigCanvas.toDataURL("image/png");
  updateSignaturePreview();
  modal.style.display = "none";
};

/* subir firma desde archivo */
window.triggerUpload = function(){
  document.getElementById("fileSignature").click();
};

document.getElementById("fileSignature").addEventListener("change", function(){
  const file = this.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    currentSignatureDataUrl = e.target.result; // data URL
    updateSignaturePreview();
  };
  reader.readAsDataURL(file);
});

/* preview firma */
function updateSignaturePreview(){
  const cont = document.getElementById("signaturePreview");
  if(currentSignatureDataUrl){
    cont.className = "signature-preview";
    cont.innerHTML = `<img src="${currentSignatureDataUrl}" alt="Firma del agente">`;
  } else {
    cont.className = "signature-preview-empty";
    cont.textContent = "Sin firma seleccionada";
  }
}

/* -------------------------------------------------------------
   GUARDAR FIRMA + COMPROMISO
-------------------------------------------------------------- */
window.saveSignature = async function(){
  if(!currentRecordId) return alert("No hay registro abierto");
  const compromiso = document.getElementById("compromiso").value.trim();
  if(!compromiso) return alert("El compromiso es obligatorio");
  if(!currentSignatureDataUrl) return alert("Debes dibujar o subir la firma del agente");

  const msg = document.getElementById("agentMsg");
  msg.style.color = "green";
  msg.textContent = "Subiendo firma y actualizando registro...";

  try{
    const sigRef = ref(storage, `firmas/${currentRecordId}.png`);
    await uploadString(sigRef, currentSignatureDataUrl, "data_url");
    const url = await getDownloadURL(sigRef);

    await updateDoc(doc(db,"registros",currentRecordId),{
      compromiso,
      firmaUrl: url,
      estado: "COMPLETADO"
    });

    msg.style.color = "green";
    msg.textContent = "Feedback completado correctamente.";
    loadAgentList();
  }catch(err){
    console.error(err);
    msg.style.color = "red";
    msg.textContent = "Error guardando firma: " + err.message;
  }
};
</script>

</body>
</html>
