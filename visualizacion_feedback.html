<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visualizaci√≥n Feedback</title>

<style>
  body{font-family:Arial;background:#f4f6fb;margin:0;padding:18px}
  .card{max-width:980px;margin:auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(10,20,30,0.06)}
  h2{margin-top:0}
  input{width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:6px}
  .doc{border:1px solid #e6eef9;padding:12px;border-radius:6px;margin-top:12px;background:#fff}
  .nota{background:#ffecec;border:1px solid #ffbdbd;color:#b30000;padding:10px;border-radius:6px;font-weight:700;text-align:center}
  .firma{border:1px solid #ddd;padding:6px;border-radius:6px;display:inline-block;margin-top:8px}
  .btn{background:#0f4c81;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;margin-top:12px}
</style>
</head>
<body>

<div class="card">
  <h2>Visualizaci√≥n del Feedback (Final)</h2>

  <label>Buscar por ID</label>
  <input id="searchId" placeholder="Pega el ID del feedback">

  <div style="display:flex;gap:8px">
    <button class="btn" onclick="showFeedback()">Mostrar</button>
    <button class="btn" onclick="downloadHtml()">Descargar HTML</button>
  </div>

  <div id="preview" class="doc" style="margin-top:14px">
    Aqu√≠ se mostrar√° el feedback final cuando busques por ID.
  </div>
</div>

<!-- ========================================= -->
<!--   FIREBASE + L√ìGICA PRINCIPAL CONECTADA  -->
<!-- ========================================= -->
<script type="module">

/* IMPORTAR FIREBASE DESDE firebase.js */
import { db, storage } from "./js/firebase.js";

import {
  doc,
  getDoc,
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  ref,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* ===========================================================
   üîç BUSCAR FEEDBACK EN COLECCI√ìN "registros"
=========================================================== */
async function showFeedback(){
  const id = document.getElementById('searchId').value.trim();
  if(!id) return alert('Ingresa un ID');

  try{
    const docRef = doc(db, "registros", id);
    const snap = await getDoc(docRef);

    if(!snap.exists())
      return alert("‚ùå No existe un registro con ese ID");

    const rec = snap.data();

    // cargar im√°genes desde storage
    rec.imagenes = await loadImages(rec.imagenes || []);

    const html = buildTemplate({ id, ...rec });
    document.getElementById("preview").innerHTML = html;

  } catch(e){
    console.error(e);
    alert("Error obteniendo datos");
  }
}

/* ===========================================================
   üì• DESCARGAR CADA IMAGEN DESDE STORAGE
=========================================================== */
async function loadImages(list){
  const arr = [];

  for(const img of list){
    try {
      const url = await getDownloadURL(ref(storage, img.url || img.storagePath));
      arr.push({ data:url });
    } catch(err){
      console.warn("No se pudo cargar imagen:", err);
    }
  }

  return arr;
}

/* ===========================================================
   üìÑ TEMPLATE HTML
=========================================================== */
function buildTemplate(rec){

  const imgsHtml = rec.imagenes.map(im =>
    `<img src="${im.data}" style="max-width:120px;margin-right:8px;border-radius:6px">`
  ).join('');

  const itemsHtml = rec.items.map(it => `
    <div style="margin-bottom:6px">
      <strong>${it.name}</strong> (${it.perc}%)
      <div>${it.detail || ''}</div>
    </div>
  `).join('');

  const firmaHtml = rec.firmaUrl
    ? `<div class="firma"><img src="${rec.firmaUrl}" style="max-width:260px"></div>`
    : `<div class="firma" style="height:80px;display:flex;align-items:center;justify-content:center;color:#64748b">
         SIN FIRMA
       </div>`;

  return `
    <div style="display:flex;justify-content:space-between;gap:16px">
      <div style="flex:1">
        <h3 style="margin:0">RETROALIMENTACI√ìN</h3>

        <div style="color:#64748b">Fecha: ${rec.fecha}</div>

        <div style="margin-top:10px">
          <strong>Asesor:</strong> ${rec.asesor} /
          <strong>Cargo:</strong> ${rec.cargo}
        </div>

        <div style="margin-top:10px">
          <strong>Cliente:</strong> ${rec.cliente?.nombre || ''} (DNI: ${rec.cliente?.dni || ''})
        </div>

        <div style="margin-top:10px">
          <strong>Resumen:</strong>
          <div style="padding:8px;background:#fbfdff;border-radius:6px">
            ${rec.resumen}
          </div>
        </div>

        <div style="margin-top:10px">
          <strong>Items observados:</strong>
          ${itemsHtml}
        </div>

        <div style="margin-top:10px">
          <strong>Evidencias:</strong>
          <div style="margin-top:6px">${imgsHtml}</div>
        </div>

        <div style="margin-top:10px">
          <strong>Compromiso del agente:</strong>
          <div style="padding:8px;border:1px dashed #e6eef9;border-radius:6px">
            ${rec.compromiso || '<em>Vac√≠o</em>'}
          </div>
        </div>
      </div>

      <div style="width:260px">
        <div class="nota" style="font-size:28px">
          ${rec.nota || 0}%
        </div>

        <div style="margin-top:12px">${firmaHtml}</div>

        <div style="margin-top:12px;color:#64748b">ID: ${rec.id}</div>
      </div>
    </div>
  `;
}

/* ===========================================================
   üì• DESCARGAR ARCHIVO HTML (como si fuera PDF)
=========================================================== */
window.downloadHtml = function (){
  const content = document.getElementById('preview').innerHTML;
  if(!content) return alert('Primero genera la vista');

  const blob = new Blob(
    [`<html><head><meta charset="utf-8"></head><body>${content}</body></html>`],
    { type:'text/html' }
  );

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (document.getElementById('searchId').value || 'feedback') + '.html';
  a.click();
};

window.showFeedback = showFeedback;

</script>
</body>
</html>
