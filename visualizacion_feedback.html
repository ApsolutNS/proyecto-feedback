<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visualizaci√≥n de Feedback ‚Äî PREMIUM DARK</title>

<!-- jsPDF + html2canvas para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ------------------- THEME DARK ------------------- */
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#0f172a;
  margin:0;
  padding:18px;
  color:#e2e8f0;
}
.card{
  max-width:1200px;
  margin:auto;
  background:#1e293b;
  padding:18px;
  border-radius:10px;
  border:1px solid #334155;
  box-shadow:0 0 25px rgba(0,0,0,0.35);
}
h2,h3{color:white;margin-top:0}
label{display:block;margin-top:10px;font-weight:600;color:#cbd5e1}
select,input{
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid #475569;
  background:#0f172a;
  color:#e2e8f0;
}
table{width:100%;border-collapse:collapse;margin-top:14px;font-size:13px}
th{
  background:#334155;
  padding:8px;
  color:#e2e8f0;
  border-bottom:1px solid #475569;
}
td{
  padding:8px;
  border-bottom:1px solid #334155;
  color:#cbd5e1;
}
.btn{
  background:#3b82f6;
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  transition:0.2s;
}
.btn:hover{background:#2563eb}
.btn.sm{padding:6px 10px;font-size:12px}
.btn.ghost{background:transparent;border:1px solid #64748b;color:#93c5fd;}

#detailBox{
  margin-top:20px;
  display:none;
  background:#0f172a;
  padding:16px;
  border-radius:10px;
  border:1px solid #334155;
}
.logo{text-align:right;margin-bottom:10px}
.logo img{max-height:45px}

.feedback-body{font-size:14px;line-height:1.5;color:#cbd5e1}

.item-block{
  margin-bottom:6px;
  padding-left:6px;
  border-left:3px solid #3b82f6;
}
.evidence-img{
  width:100%;
  max-width:650px;
  border-radius:6px;
  margin-top:8px;
  border:1px solid #475569;
}

#pdfBtn{
  margin-top:12px;
  background:#10b981 !important;
}
</style>
</head>

<body>
<div class="card">
  <h2>Visualizaci√≥n de Feedback ‚Äî Modo DARK</h2>

  <!-- FILTROS -->

  <label>Filtrar por asesor</label>
  <select id="filtroAsesor">
    <option value="">‚Äî Todos ‚Äî</option>
  </select>

  <label>Filtrar por qui√©n registr√≥</label>
  <select id="filtroRegistrado">
    <option value="">‚Äî Todos ‚Äî</option>
    <option value="Alex Paolo Nu√±ez Sulca - L√≠der de Calidad y Formaci√≥n">
      Alex Paolo Nu√±ez Sulca - L√≠der de Calidad y Formaci√≥n
    </option>
    <option value="C√©sar Alonso Torres Montes - Supervisor">
      C√©sar Alonso Torres Montes - Supervisor
    </option>
    <option value="Karen Vanessa Vital Cordova - L√≠der de Operaciones">
      Karen Vanessa Vital Cordova - L√≠der de Operaciones
    </option>
  </select>

  <table id="tablaFeedback">
    <thead>
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Asesor</th>
        <th>Nota</th>
        <th>Registrado por</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- DETALLE -->
  <div id="detailBox">
    <div class="logo">
      <img src="https://firebasestorage.googleapis.com/v0/b/feedback-app-ac30e.firebasestorage.app/o/firmas%2FImagen1.png?alt=media&token=730b1e7c-abbf-4369-9e8c-fafad2b39883">
    </div>

    <h3>Detalle del Feedback</h3>
    <div id="detailContent" class="feedback-body"></div>

    <button id="pdfBtn" class="btn">Exportar PDF</button>
  </div>

</div>

<script type="module">
/* ---------------- FIREBASE ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getFirestore, collection, getDocs 
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyD4cFHDbSfJNAhTuuP01N5JZQd-FOYB2LM",
  authDomain:"feedback-app-ac30e.firebaseapp.com",
  projectId:"feedback-app-ac30e",
  storageBucket:"feedback-app-ac30e.firebasestorage.app"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------------- LOAD LIST ---------------- */
let registros = [];

async function cargarRegistros() {
  const snap = await getDocs(collection(db, "registros"));
  registros = [];

  snap.forEach(d => {
    const r = d.data();
    registros.push({
      id: d.id,
      ...r,
      fechaObj: new Date(r.fecha),
      registradoPor: r.registradoPor || ""  // üëà AQUI LA CORRECCI√ìN
    });
  });

  registros.sort((a, b) => b.fechaObj - a.fechaObj);
}

/* -------- FILL FILTERS -------- */
function cargarAsesoresFiltro() {
  const asesores = [...new Set(registros.map(r => r.asesor))].sort();
  filtroAsesor.innerHTML = `<option value="">‚Äî Todos ‚Äî</option>`;

  asesores.forEach(a => {
    filtroAsesor.innerHTML += `<option value="${a}">${a}</option>`;
  });
}

/* ------------ RENDER TABLE ---------------- */
function renderTabla() {
  const filAs = filtroAsesor.value;
  const filReg = filtroRegistrado.value;

  const t = document.querySelector("#tablaFeedback tbody");
  t.innerHTML = "";

  registros
    .filter(r => !filAs || r.asesor === filAs)
    .filter(r => !filReg || r.registradoPor === filReg)  // üëà CORREGIDO
    .forEach(r => {
      t.innerHTML += `
        <tr>
          <td>${r.id}</td>
          <td>${r.fechaObj.toLocaleString("es-PE")}</td>
          <td>${r.asesor}</td>
          <td>${r.nota}%</td>
          <td>${r.registradoPor || "-"}</td>
          <td><button class="btn sm" onclick="verDetalle('${r.id}')">Ver</button></td>
        </tr>
      `;
    });
}

/* ---------------- DETALLE ------------------- */
window.verDetalle = function(id){
  const r = registros.find(x => x.id === id);
  if (!r) return;

  const itemsHtml = (r.items || []).map(it => `
    <div class="item-block">
      <b>${it.name}</b> (${it.perc}%)
      <div>${it.detail || ""}</div>
    </div>
  `).join("");

  const evidencias = (r.imagenes || []).map(im => `
    <img class="evidence-img" src="${im.url}">
  `).join("");

  document.getElementById("detailContent").innerHTML = `
    <p><b>Registrado por:</b> ${r.registradoPor}</p>
    <p><b>Asesor:</b> ${r.asesor} (GC: ${r.gc || ""})</p>
    <p><b>Fecha:</b> ${r.fechaObj.toLocaleString("es-PE")}</p>

    <div class="section-title">Cliente</div>
    DNI: ${r.cliente?.dni || ""}<br>
    Nombre: ${r.cliente?.nombre || ""}<br>
    Tel√©fono: ${r.cliente?.tel || ""}<br>

    <div class="section-title">Resumen</div>
    ${r.resumen || ""}

    <div class="section-title">√çtems observados</div>
    ${itemsHtml || "<em>Sin √≠tems</em>"}

    <div class="section-title">Nota final</div>
    <b style="font-size:22px">${r.nota}%</b>

    <div class="section-title">Evidencias</div>
    ${evidencias}
  `;

  document.getElementById("detailBox").style.display = "block";
  window._CURRENT_FEEDBACK_ID = id;
};

/* ---------------- PDF EXPORT ---------------- */
document.getElementById("pdfBtn").onclick = async () => {
  const element = document.getElementById("detailBox");
  const canvas = await html2canvas(element, { scale: 2 });
  const img = canvas.toDataURL("image/png");

  const pdf = new jspdf.jsPDF("p","mm","a4");
  const w = pdf.internal.pageSize.getWidth() - 20;
  const h = (canvas.height * w) / canvas.width;

  pdf.addImage(img, "PNG", 10, 10, w, h);
  pdf.save(`feedback_${window._CURRENT_FEEDBACK_ID}.pdf`);
};

/* ---------------- INIT ---------------- */
window.onload = async () => {
  await cargarRegistros();
  cargarAsesoresFiltro();
  renderTabla();
  filtroAsesor.onchange = renderTabla;
  filtroRegistrado.onchange = renderTabla;
};
</script>

</body>
</html>
