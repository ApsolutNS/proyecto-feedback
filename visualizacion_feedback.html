<script>
// ===============================
// ðŸ”µ OBTENER TODOS LOS REGISTROS
// ===============================
async function getAllRecords(){
  try {
    const resp = await fetch("/.netlify/functions/records");
    const json = await resp.json();

    if (!json.ok) return [];

    return json.records || [];
  } catch (e) {
    console.error(e)
    alert("Error obteniendo registros del servidor");
    return [];
  }
}

// ===============================
// ðŸ” MOSTRAR FEEDBACK POR ID
// ===============================
async function showFeedback(){
  const id = document.getElementById('searchId').value.trim();
  if(!id) return alert('Ingresa un ID');

  const records = await getAllRecords();
  const rec = records.find(r => r.id === id);

  if(!rec){
    return alert('No se encontrÃ³ un feedback con ese ID');
  }

  const html = buildTemplate(rec);
  document.getElementById('preview').innerHTML = html;
}

// ===============================
// ðŸ“„ ARMAR PLANTILLA
// ===============================
function buildTemplate(rec){

  // ========== CORREGIR CAMPOS ==========

  // Items vienen como JSON texto
  let items = [];
  try { items = JSON.parse(rec.items || "[]"); } catch(e){}

  // Images vienen como JSON texto
  let imgs = [];
  try { imgs = JSON.parse(rec.images || "[]"); } catch(e){}

  // Firma URL real
  const firma = rec.firmaUrl ? `<img src="${rec.firmaUrl}" style="max-width:260px">` :
      `<div style="color:#777">SIN FIRMA</div>`;

  const imgsHtml = imgs.map(im =>
    `<img src="${im.data}" style="max-width:120px;margin-right:8px;border-radius:6px">`
  ).join('');

  const itemsHtml = items.map(it => `
    <div style="margin-bottom:6px">
      <strong>${it.name}</strong> (${it.perc}%)
      <div style="color:#333">${it.detail || ''}</div>
    </div>
  `).join('');

  // ========== PLANTILLA FINAL ==========
  return `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px">
      <div style="flex:1">
        <h3 style="margin:0">RETROALIMENTACIÃ“N</h3>

        <div style="color:#64748b">
          Fecha: ${rec.fechaHora}
        </div>

        <div style="margin-top:10px">
          <strong>Asesor:</strong> ${rec.asesor} /
          <strong>Cargo:</strong> ${rec.cargo}
        </div>

        <div style="margin-top:10px;">
          <strong>Cliente:</strong> ${rec.nombreCliente}
          (DNI: ${rec.dniCliente})
        </div>

        <div style="margin-top:10px">
          <strong>Resumen:</strong>
          <div style="padding:8px;background:#fbfdff;border-radius:6px">
            ${rec.resumen}
          </div>
        </div>

        <div style="margin-top:10px">
          <strong>Items observados:</strong>
          ${itemsHtml}
        </div>

        <div style="margin-top:10px">
          <strong>Reincidencia:</strong> ${rec.reincidencia}
        </div>

        <div style="margin-top:10px">
          <strong>Evidencias:</strong>
          <div style="margin-top:6px">${imgsHtml}</div>
        </div>

        <div style="margin-top:10px">
          <strong>Compromiso del agente:</strong>
          <div style="padding:8px;border:1px dashed #e6eef9;border-radius:6px">
            ${rec.compromiso || '<em>VacÃ­o</em>'}
          </div>
        </div>
      </div>

      <div style="width:260px">
        <div class="nota" style="font-size:28px">
          ${rec.nota}%
        </div>
        <div style="margin-top:12px">${firma}</div>
        <div style="margin-top:12px;color:#64748b">ID: ${rec.id}</div>
      </div>
    </div>
  `;
}

// ===============================
// ðŸ“¥ DESCARGAR HTML
// ===============================
function downloadHtml(){
  const div = document.getElementById('preview');
  const content = div.innerHTML;

  if(!content) return alert('Genera la vista antes de descargar');

  const blob = new Blob(
    [`<html><head><meta charset="utf-8"></head><body>${content}</body></html>`],
    { type:'text/html' }
  );

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (document.getElementById('searchId').value || 'feedback') + '.html';
  a.click();
}
</script>
