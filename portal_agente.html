<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal del Agente</title>

<style>
  body{font-family:Arial;background:#f4f6fb;margin:0;padding:18px}
  .card{max-width:980px;margin:auto;background:#fff;padding:18px;border-radius:8px;
        box-shadow:0 6px 18px rgba(10,20,30,0.06)}
  h2{margin-top:0}
  label{display:block;margin-top:10px;font-weight:600}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
  th{background:#fbfdff}
  .btn{background:#0f4c81;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;margin-top:10px}
  .btn.ghost{background:#fff;color:#0f4c81;border:1px solid #cbd5e1}

  /* POPUP */
  #popup{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;
  }
  #popupContent{
    background:white;padding:20px;border-radius:10px;max-width:760px;width:90%;
    box-shadow:0 4px 18px rgba(0,0,0,0.3)
  }
  canvas{border:1px solid #ccc;border-radius:6px}
</style>
</head>

<body>

<div class="card">
  <h2>Portal del Agente</h2>

  <label>Seleccionar Asesor</label>
  <select id="selAgent" onchange="loadAgentList()">
    <option value="">-- selecciona --</option>
  </select>

  <div style="margin-top:12px">
    <strong>Feedbacks del agente</strong>
    <table id="agentTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Nota</th>
          <th>Estado</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="detailBlock" style="display:none;margin-top:12px">
    <h3>Completar Feedback</h3>

    <div id="feedbackInfo"></div>

    <label>Compromiso del agente</label>
    <textarea id="compromiso" rows="4"></textarea>

    <label>Selecciona cómo deseas firmar</label>
    <div style="display:flex;gap:10px;margin-top:5px">
      <button class="btn" onclick="openPopup()">DIBUJAR FIRMA</button>
      <button class="btn" onclick="document.getElementById('fileInput').click()">SUBIR FIRMA</button>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="uploadFirmImage(event)">

    <div id="agentMsg" style="margin-top:10px;color:green"></div>
  </div>
</div>


<!-- ================= POPUP PARA DIBUJAR ================= -->
<div id="popup">
  <div id="popupContent">
    <h3>Firmar</h3>

    <canvas id="canvas" width="700" height="160"></canvas>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" onclick="saveSignatureCanvas()">Guardar Firma</button>
      <button class="btn ghost" onclick="clearCanvas()">Limpiar</button>
      <button class="btn ghost" onclick="closePopup()">Cancelar</button>
    </div>
  </div>
</div>


<script type="module">

/* ---------------------- FIREBASE ---------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, where,
  doc, getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

import {
  getStorage, ref, uploadString, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyD4cFHDbSfJNAhTuuP01N5JZQd-FOYB2LM",
  authDomain: "feedback-app-ac30e.firebaseapp.com",
  projectId: "feedback-app-ac30e",
  storageBucket: "feedback-app-ac30e.firebasestorage.app",
  messagingSenderId: "512179147778",
  appId: "1:512179147778:web:795e4a8b177fe766d3431b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------------------- VARIABLES ---------------------- */
let asesoresByNombre = {};
let currentRecordId = null;


/* ------------------- CARGAR ASESORES -------------------- */
async function loadAdvisors(){
  const snap = await getDocs(collection(db,"asesores"));
  asesoresByNombre = {};

  snap.forEach(d=>{
    const {nombre, GC} = d.data();
    if(nombre) asesoresByNombre[nombre] = GC || "SIN GC";
  });

  const sel = document.getElementById("selAgent");
  sel.innerHTML = '<option value="">-- selecciona --</option>';

  Object.keys(asesoresByNombre).sort().forEach(n=>{
    sel.innerHTML += `<option>${n}</option>`;
  });
}
loadAdvisors();


/* ------------------- PARSE FECHA ----------------------- */
function parseFecha(r){
  if(r.fechaHora?.toDate) return r.fechaHora.toDate();
  if(r.fecha?.toDate) return r.fecha.toDate();
  return new Date(r.fecha || Date.now());
}


/* ---------------- LISTAR FEEDBACKS --------------------- */
window.loadAgentList = async function(){
  const advisor = document.getElementById("selAgent").value;
  const tbody = document.querySelector("#agentTable tbody");

  if(!advisor){
    tbody.innerHTML = '<tr><td colspan="5">Selecciona un asesor</td></tr>';
    return;
  }

  const qRef = query(collection(db,"registros"), where("asesor","==",advisor));
  const snap = await getDocs(qRef);

  const list=[];
  snap.forEach(d=>{
    const data=d.data();
    list.push({
      id:d.id,
      nota:data.nota ?? 0,
      estado:data.estado || "PENDIENTE",
      fecha:parseFecha(data)
    });
  });

  list.sort((a,b)=>b.fecha - a.fecha);

  tbody.innerHTML = list.map(r=>`
    <tr>
      <td>${r.id}</td>
      <td>${r.fecha.toLocaleString("es-PE")}</td>
      <td>${r.nota}%</td>
      <td>${r.estado}</td>
      <td><button onclick="openDetail('${r.id}')">Abrir</button></td>
    </tr>`).join("") || '<tr><td colspan="5">Sin registros</td></tr>';
};


/* ---------------- ABRIR DETALLE ------------------------ */
window.openDetail = async function(id){
  const snap = await getDoc(doc(db,"registros",id));
  if(!snap.exists()) return alert("Registro no encontrado");
  
  currentRecordId = id;
  const rec = snap.data();

  document.getElementById("feedbackInfo").innerHTML = `
    <div><b>ID:</b> ${id}</div>
    <div><b>Fecha:</b> ${parseFecha(rec).toLocaleString("es-PE")}</div>
    <div><b>Asesor:</b> ${rec.asesor} — ${asesoresByNombre[rec.asesor] || "SIN GC"}</div>
    <div><b>Tipo:</b> ${rec.tipo}</div>
    <div><b>Nota:</b> ${rec.nota || 0}%</div>
    <div style="margin-top:8px"><b>Resumen:</b> ${rec.resumen || ""}</div>
  `;

  document.getElementById("compromiso").value = rec.compromiso || "";
  document.getElementById("detailBlock").style.display = "block";
};


/* -------------------- POPUP --------------------------- */
window.openPopup = function(){
  document.getElementById("popup").style.display = "flex";
};

window.closePopup = function(){
  document.getElementById("popup").style.display = "none";
};


/* ------------------ CANVAS ---------------------------- */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let drawing = false;

canvas.addEventListener("mousedown",()=>drawing=true);
canvas.addEventListener("mouseup",()=>{drawing=false;ctx.beginPath();});
canvas.addEventListener("mousemove",e=>{
  if(!drawing) return;
  const r = canvas.getBoundingClientRect();
  ctx.lineWidth=2;
  ctx.lineCap="round";
  ctx.strokeStyle="#000";
  ctx.lineTo(e.clientX-r.left, e.clientY-r.top);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(e.clientX-r.left, e.clientY-r.top);
});

window.clearCanvas = function(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
};


/* ----------- GUARDAR FIRMA DIBUJADA ------------------ */
window.saveSignatureCanvas = async function(){
  if(!currentRecordId) return alert("No hay registro activo");
  const compromiso = document.getElementById("compromiso").value.trim();
  if(!compromiso) return alert("Ingresa tu compromiso");

  const msg = document.getElementById("agentMsg");
  msg.textContent = "Guardando firma...";

  const dataUrl = canvas.toDataURL("image/png");
  const sigRef = ref(storage, `firmas/${currentRecordId}.png`);

  await uploadString(sigRef, dataUrl, "data_url");
  const url = await getDownloadURL(sigRef);

  await updateDoc(doc(db,"registros",currentRecordId),{
    compromiso,
    firmaUrl: url,
    estado: "COMPLETADO"
  });

  msg.textContent = "Firma guardada correctamente";
  closePopup();
  loadAgentList();
};


/* ----------- SUBIR FIRMA DESDE ARCHIVOS --------------- */
window.uploadFirmImage = async function(event){
  if(!currentRecordId) return alert("No hay registro activo");

  const compromiso = document.getElementById("compromiso").value.trim();
  if(!compromiso) return alert("Ingresa tu compromiso");

  const file = event.target.files[0];
  if(!file) return;

  const msg = document.getElementById("agentMsg");
  msg.textContent = "Subiendo imagen...";

  const sigRef = ref(storage, `firmas/${currentRecordId}.png`);
  await uploadBytes(sigRef, file);
  const url = await getDownloadURL(sigRef);

  await updateDoc(doc(db,"registros",currentRecordId),{
    compromiso,
    firmaUrl: url,
    estado: "COMPLETADO"
  });

  msg.textContent = "Firma subida correctamente";
  loadAgentList();
};

</script>

</body>
</html>
