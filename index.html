<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro del Monitoreo</title>

<style>
  body{font-family:Arial;background:#f4f6fb;margin:0;padding:18px}
  .card{max-width:980px;margin:auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(10,20,30,0.06)}
  h2{margin-top:0}
  label{display:block;margin-top:10px;font-weight:600}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef;margin-top:6px;box-sizing:border-box}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .items-list{margin-top:10px}
  .item-block{border:1px solid #e6eef9;padding:8px;border-radius:6px;margin-top:8px;display:flex;gap:8px;align-items:flex-start}
  .btn{background:#0f4c81;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;margin-top:12px}
  .btn.ghost{background:#fff;color:#0f4c81;border:1px solid #cbd5e1}
  .small{font-size:13px;color:#64748b}
  .img-preview{max-height:90px;margin-right:8px;border-radius:6px}
</style>
</head>

<body>

<div class="card">
  <h2>Registro del Monitoreo (Supervisor)</h2>

  <label>ID LLAMADA</label>
  <input id="idLlamada">

  <label>ID CONTACTO</label>
  <input id="idContacto">

  <label>Tipo detectado</label>
  <input id="tipoDetectado" readonly>

  <div style="display:flex;gap:8px;margin-top:10px">
    <div style="flex:1">
      <label>Asesor</label>
      <select id="asesor"></select>
      <small class="small">* Cargado desde Firestore</small>
    </div>

    <div style="width:220px">
      <label>Cargo</label>
      <select id="cargo">
        <option>ASESOR INBOUND</option>
        <option>ASESOR CORREOS</option>
        <option>ASESOR REDES</option>
      </select>
    </div>
  </div>

  <h3 class="small" style="margin-top:12px">Datos del cliente</h3>

  <div class="row">
    <div class="col">
      <label>DNI cliente</label>
      <input id="cliDni">
    </div>

    <div class="col">
      <label>Nombre cliente</label>
      <input id="cliNombre">
    </div>

    <div class="col">
      <label>Teléfono</label>
      <input id="cliTel">
    </div>
  </div>

  <label>Tipificación</label>
  <input id="cliTipif">

  <label>Observación cliente</label>
  <textarea id="cliObs"></textarea>

  <label>Resumen de la llamada</label>
  <textarea id="resumen" rows="4"></textarea>

  <h3 style="margin-top:12px">Items observados</h3>
  <div class="small">Agrega uno o varios items</div>

  <div style="display:flex;gap:8px;margin-top:8px">
    <button class="btn" onclick="addItemBlock()">+ Agregar ítem</button>
    <button class="btn ghost" onclick="clearItems()" style="width:130px">Limpiar items</button>
  </div>

  <div id="itemsContainer" class="items-list"></div>

  <label style="margin-top:12px">Adjuntar imágenes</label>
  <input id="imgs" type="file" multiple accept="image/*" />
  <div id="imgPreview" style="display:flex;margin-top:8px;flex-wrap:wrap"></div>

  <button class="btn" onclick="submitRecord()">Registrar</button>
  <div id="msg" style="margin-top:12px;color:green"></div>
</div>

<script type="module">

/* --------------------- FIREBASE IMPORTS ---------------------- */
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";

import {
  getFirestore, collection, addDoc, getDocs
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

/* --------------------- CONFIG ------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD4cFHDbSfJNAhTuuP01N5JZQd-FOYB2LM",
  authDomain: "feedback-app-ac30e.firebaseapp.com",
  projectId: "feedback-app-ac30e",
  storageBucket: "feedback-app-ac30e.firebasestorage.app",
  messagingSenderId: "512179147778",
  appId: "1:512179147778:web:795e4a8b177fe766d3431b",
  measurementId: "G-X6MP0FFH9P"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* --------------------- CARGAR ASESORES (nombre + GC) ------------------------- */
async function cargarAsesores() {
  try {
    const snap = await getDocs(collection(db, "asesores"));
    const lista = [];

    snap.forEach(d => {
      const data = d.data();
      lista.push({
        id: d.id,
        nombre: data.nombre || "SIN NOMBRE",
        gc: data.GC || "SIN GC"
      });
    });

    lista.sort((a,b)=> a.nombre.localeCompare(b.nombre));

    const sel = document.getElementById("asesor");

    sel.innerHTML = lista.map(a =>
      `<option value="${a.nombre}" data-gc="${a.gc}">
         ${a.nombre} — ${a.gc}
       </option>`
    ).join("");

  } catch (err) {
    console.error("Error cargando asesores:", err);
  }
}
cargarAsesores();

/* --------------------- DETECTAR TIPO -------------------------- */
function detectarTipoTexto(text){
  if(!text) return 'NO IDENTIFICADO';
  text = text.toLowerCase();

  if(text.includes('intefectivank') || text.includes('vank')) return 'EFECTIVANK';
  if(text.includes('intefectiva')) return 'EFECTIVA';
  if(text.includes('intxperto')) return 'XPERTO';
  if(text.includes('facebook')) return 'FACEBOOK';
  if(text.includes('instagram')) return 'INSTAGRAM';
  if(text.includes('correo') || text.includes('mail')) return 'CORREO';

  return 'OTRO';
}

document.getElementById('idLlamada').addEventListener('input', updateDetected);
document.getElementById('idContacto').addEventListener('input', updateDetected);

function updateDetected(){
  const v = idLlamada.value + " " + idContacto.value;
  tipoDetectado.value = detectarTipoTexto(v);
}

/* --------------------- ITEMS DISPONIBLES ---------------------- */
const ITEMS = [
  ["Corte de Gestión","ERROR_INEXCUSABLE"],
  ["Insulto / Falta de Respeto","ERROR_INEXCUSABLE"],
  ["Normativa Regulatoria","ERROR_INEXCUSABLE"],
  ["Protección de datos","ERROR_INEXCUSABLE"],

  ["Presentación","PENCUF"],
  ["Personalización","PENCUF"],
  ["Despedida","PENCUF"],
  ["Escucha Activa","PENCUF"],
  ["Sondeo","PENCUF"],
  ["Optimización de esperas","PENCUF"],
  ["Solicita datos correctamente","PENCUF"],
  ["Herramientas de Gestión","PENCUF"],
  ["Codificación y Registro","PENCUF"],
  ["Encuesta de satisfacción","PENCUF"],
  ["Contestación sin demora","PENCUF"],

  ["Lenguaje","PECNEG"],
  ["Voz","PECNEG"],
  ["Actitud comercial","PECNEG"],
  ["Operativa","PECNEG"],
  ["Imagen trasladada","PECNEG"],
  ["Redacta de forma correcta","PECNEG"],
  ["Transferencia","PECNEG"],
  ["Tramita la gestión correspondiente","PECNEG"],

  ["Actitud - Manejo de llamada","PECUF"],
  ["Solución al primer contacto","PECUF"],
  ["Cumple con devolución de llamado","PECUF"],
  ["Conocimientos para resolver la consulta","PECUF"],
  ["Asesoramiento de producto/servicio","PECUF"],

  ["Verificación de datos","PECCUMP"],
  ["Número de Ticket entregado","PECCUMP"],

  ["Ninguno","NINGUNO"]
];

/* --------------------- AGREGAR ITEM ---------------------- */
window.addItemBlock = function() {
  const w = document.createElement('div');
  w.className = 'item-block';
  w.innerHTML = `
    <select>
      ${ITEMS.map(it => `<option value="${it[0]}||${it[1]}">${it[0]}</option>`).join("")}
    </select>
    <textarea placeholder="Detalle del ítem"></textarea>
    <button class="btn ghost" style="width:90px" onclick="this.parentNode.remove()">Eliminar</button>
  `;
  document.getElementById("itemsContainer").appendChild(w);
}

window.clearItems = ()=> document.getElementById("itemsContainer").innerHTML = "";

/* --------------------- PREVIEW IMÁGENES ---------------------- */
document.getElementById('imgs').addEventListener('change', function(){
  const preview = document.getElementById('imgPreview');
  preview.innerHTML = "";

  [...this.files].forEach(f=>{
    const fr = new FileReader();
    fr.onload = e=>{
      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "img-preview";
      img.style.maxWidth = "120px";
      preview.appendChild(img);
    };
    fr.readAsDataURL(f);
  });
});

/* --------------------- FORMULA DE NOTA ---------------------- */
function calcularNota(items){

  if(items.some(i => i.tipo === "ERROR_INEXCUSABLE")) return 0;

  const grupos = {
    PENCUF: 0,
    PECNEG: 0,
    PECUF: 0,
    PECCUMP: 0
  };

  items.forEach(i=> grupos[i.tipo]++ );

  let nota = 100;

  if(grupos.PENCUF === 1)       nota = 87.5;
  else if(grupos.PENCUF >= 2)   nota = 75;

  if(grupos.PECNEG >= 1)        nota = 70;

  if(grupos.PECUF >= 1)         nota = 65;

  if(grupos.PECCUMP >= 1)       nota = 90;

  return Math.max(0, nota);
}

/* --------------------- GUARDAR REGISTRO ---------------------- */
window.submitRecord = async function() {
  const msgEl = document.getElementById('msg');
  msgEl.style.color = 'green';
  msgEl.textContent = "⏳ Subiendo...";

  try{
    const items = [...document.querySelectorAll(".item-block")].map(b=>{
      const [name,tipo] = b.querySelector("select").value.split("||");
      return {
        name,
        tipo,
        detail: b.querySelector("textarea").value
      };
    });

    const nota = calcularNota(items);

    const files = document.getElementById('imgs').files;
    const imageURLs = [];

    for(const f of files){
      const storageRef = ref(storage, `monitoreo_imagenes/${Date.now()}_${f.name}`);
      await uploadBytes(storageRef, f);
      const url = await getDownloadURL(storageRef);
      imageURLs.push({name: f.name, url, storagePath: storageRef.fullPath});
    }

    const asesorSel = document.getElementById('asesor');
    const gc = asesorSel.options[asesorSel.selectedIndex].dataset.gc;

    const data = {
      idLlamada: idLlamada.value,
      idContacto: idContacto.value,
      tipo: tipoDetectado.value,
      asesor: asesorSel.value,
      gc,
      cargo: cargo.value,
      cliente:{
        dni: cliDni.value,
        nombre: cliNombre.value,
        tel: cliTel.value
      },
      tipificacion: cliTipif.value,
      observacionCliente: cliObs.value,
      resumen: resumen.value,
      items,
      nota,
      imagenes: imageURLs,
      fecha: new Date().toISOString()
    };

    await addDoc(collection(db, "registros"), data);

    msgEl.style.color = 'green';
    msgEl.textContent = "✔ Guardado correctamente";

    clearItems();
    document.getElementById('imgPreview').innerHTML = "";

  } catch(err){
    msgEl.style.color = 'red';
    msgEl.textContent = "❌ Error: " + err.message;
    console.error(err);
  }
}

</script>

</body>
</html>
